<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#ff7a18"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="TuQR"/>
<link rel="manifest" href="./manifest.json"/>
<link rel="apple-touch-icon" href="./LogoQ_transparent.png"/>
<title>Mi Usuario ‚Äî TuQR</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
  :root{
    --primary:#ff7a18; --accent:#ffd400; --bg:#f2f3f5; --card:#ffffff;
    --text:#1a1a1a; --muted:#5a5a5a; --border:rgba(0,0,0,.08);
    --shadow:0 10px 24px rgba(0,0,0,.08); --radius:18px; --danger:#c00;
  }
  *{ box-sizing:border-box; }
  body{ font-family:"Poppins",system-ui,sans-serif; margin:0; padding:16px 12px; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; min-height:100vh; }
  .wrap{ max-width:480px; margin:0 auto; display:flex; flex-direction:column; gap:16px; }

  /* Topbar con hamburguesa */
  .topbar{ display:flex; align-items:center; gap:12px; }
  .hamburger{
    background:var(--primary); border:none; cursor:pointer; padding:10px 12px; border-radius:12px;
    display:flex; flex-direction:column; gap:5px; box-shadow:0 3px 10px rgba(255,122,24,.35);
    -webkit-tap-highlight-color:transparent; transition:filter .1s, transform .06s;
  }
  .hamburger span{ display:block; width:22px; height:2.5px; border-radius:2px; background:#fff; }
  .hamburger:active{ transform:scale(.95); filter:brightness(.92); }
  .topbar-title{ font-size:16px; font-weight:800; }

  /* Drawer */
  .drawer-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:200; }
  .drawer-overlay.open{ display:block; }
  .drawer{
    position:fixed; top:0; left:-260px; bottom:0; width:240px; background:#fff; z-index:201;
    box-shadow:4px 0 28px rgba(0,0,0,.18); transition:left .22s cubic-bezier(.4,0,.2,1); display:flex; flex-direction:column;
  }
  .drawer.open{ left:0; }
  .drawer-header{ padding:32px 20px 22px; background:linear-gradient(135deg,var(--primary),var(--accent)); }
  .drawer-logo{ width:100px; height:auto; filter:brightness(10); }
  .drawer-body{ padding:16px 8px; display:flex; flex-direction:column; gap:4px; flex:1; }
  .drawer-item{
    display:flex; align-items:center; gap:14px; padding:15px 14px; border-radius:12px;
    font-size:15px; font-weight:700; color:var(--text); cursor:pointer;
    background:none; border:none; font-family:inherit; width:100%; text-align:left;
    -webkit-tap-highlight-color:transparent; transition:background .1s;
  }
  .drawer-item:active{ background:#f2f2f2; }
  .drawer-item .di-icon{ font-size:20px; width:30px; text-align:center; }
  .drawer-sep{ border:none; border-top:1px solid rgba(0,0,0,.08); margin:8px 14px; }
  .drawer-item.danger{ color:#c00; }

  /* Card */
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    padding:24px 20px 28px; box-shadow:var(--shadow); position:relative; overflow:hidden; display:flex; flex-direction:column;
  }
  .card::before{ content:""; position:absolute; top:0; left:0; right:0; height:8px; background:linear-gradient(90deg,rgba(255,212,0,.95),rgba(255,122,24,.95)); }
  .card-title{ font-size:18px; font-weight:800; margin:4px 0 18px; }

  /* RUT pill */
  .rut-pill{ display:inline-flex; align-items:center; gap:10px; margin-bottom:16px; padding:10px 14px; border-radius:12px; background:#f5f5f5; border:1px solid var(--border); }
  .rut-pill-label{ font-size:11px; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; }
  .rut-pill-value{ font-size:15px; font-weight:800; color:var(--text); }

  /* Campos */
  label{ font-weight:700; font-size:13px; color:var(--muted); margin-top:14px; display:block; margin-bottom:5px; }
  input{ width:100%; padding:11px 12px; font-size:14px; font-family:inherit; border:1.5px solid rgba(0,0,0,.12); border-radius:12px; background:#fff; color:var(--text); outline:none; transition:border-color .15s, box-shadow .15s; -webkit-appearance:none; }
  input:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(255,122,24,.12); }
  input.valid{ border-color:#0a7; background:#f5fbf8; }
  input.invalid{ border-color:#e00; background:#fff8f8; }
  .field-err{ color:#c00; font-size:12px; font-weight:600; margin-top:4px; display:none; }
  .field-err.show{ display:block; }
  .phone-wrap{ display:flex; gap:8px; }
  .phone-prefix{ width:52px; flex-shrink:0; padding:11px 8px; font-size:13px; font-family:inherit; border:1.5px solid rgba(0,0,0,.12); border-radius:12px; background:#f7f7f7; color:var(--muted); text-align:center; outline:none; }
  .phone-wrap input{ flex:1; min-width:0; }

  /* Botones */
  .cta{ margin-top:22px; padding:13px; width:100%; font-size:15px; font-weight:800; font-family:inherit; border:0; border-radius:12px; cursor:pointer; color:#fff; background:var(--primary); box-shadow:0 6px 12px rgba(255,122,24,.22); -webkit-tap-highlight-color:transparent; transition:transform .06s, filter .06s; }
  .cta:active{ transform:translateY(1px); filter:brightness(.98); }
  .cta:disabled{ background:#ccc; box-shadow:none; cursor:not-allowed; }
  .msg-ok{ margin-top:12px; padding:10px 12px; border-radius:12px; font-size:14px; font-weight:700; color:#0a7; background:rgba(0,170,120,.10); border:1px solid rgba(0,170,120,.18); display:none; text-align:center; }
  .msg-err{ margin-top:12px; padding:10px 12px; border-radius:12px; font-size:14px; font-weight:800; color:#b00; background:rgba(190,0,0,.08); border:1px solid rgba(190,0,0,.14); display:none; }

  /* Eliminar */
  .delete-section{ margin-top:28px; padding-top:20px; border-top:1px dashed rgba(0,0,0,.10); display:flex; flex-direction:column; gap:8px; }
  .delete-desc{ font-size:12px; color:var(--muted); line-height:1.5; }
  .btn-danger{ padding:13px; width:100%; font-size:15px; font-weight:800; font-family:inherit; border:2px solid var(--danger); border-radius:12px; cursor:pointer; color:var(--danger); background:#fff; -webkit-tap-highlight-color:transparent; transition:background .1s; }
  .btn-danger:active{ background:rgba(190,0,0,.07); }

  /* Modal */
  .modal-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:500; align-items:flex-end; justify-content:center; }
  .modal-overlay.open{ display:flex; }
  .modal-box{ background:#fff; border-radius:24px 24px 0 0; padding:28px 20px 40px; width:100%; max-width:480px; box-shadow:0 -8px 32px rgba(0,0,0,.15); animation:slideUp .25s ease; display:flex; flex-direction:column; gap:12px; }
  @keyframes slideUp{ from{ transform:translateY(100%); } to{ transform:translateY(0); } }
  .modal-handle{ width:40px; height:4px; border-radius:999px; background:#ddd; margin:0 auto 8px; display:block; }
  .modal-title{ font-size:18px; font-weight:800; color:var(--danger); }
  .modal-desc{ font-size:13px; color:var(--muted); line-height:1.5; }
  .btn-confirm-danger{ padding:13px; width:100%; font-size:15px; font-weight:800; font-family:inherit; border:0; border-radius:12px; cursor:pointer; color:#fff; background:var(--danger); }
  .btn-cancel{ padding:13px; width:100%; font-size:15px; font-weight:800; font-family:inherit; border:0; border-radius:12px; cursor:pointer; color:var(--text); background:#f0f0f0; }

  /* Skeleton */
  .skeleton-line{ height:14px; border-radius:8px; background:linear-gradient(90deg,#e8e8e8 25%,#f4f4f4 50%,#e8e8e8 75%); background-size:200% 100%; animation:shimmer 1.2s infinite; }
  @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  .loading-wrap{ display:flex; flex-direction:column; gap:12px; padding:8px 0; }

  /* Modal contacto */
  input[type=email], select, textarea{ width:100%; padding:11px 12px; font-size:14px; font-family:inherit; border:1.5px solid rgba(0,0,0,.12); border-radius:12px; background:#fff; color:var(--text); outline:none; transition:border-color .15s; -webkit-appearance:none; appearance:none; }
  textarea{ resize:vertical; min-height:90px; }
  .char-count{ font-size:11px; color:var(--muted); text-align:right; margin-top:3px; }
  .field-err-modal{ color:#c00; font-size:12px; font-weight:600; margin-top:4px; display:none; }
  .field-err-modal.show{ display:block; }
</style>
</head>
<body>

<div class="drawer-overlay" id="drawerOverlay"></div>

<!-- Drawer Mi Usuario: Mis Cuentas + Cambiar de usuario + Contacto -->
<nav class="drawer" id="drawer">
  <div class="drawer-header"><img class="drawer-logo" src="./TuQRLogo.png" alt="TuQR"/></div>
  <div class="drawer-body">
    <button class="drawer-item" id="menuMisCuentas">
      <span class="di-icon">‚äû</span> Mis Cuentas
    </button>
    <hr class="drawer-sep"/>
    <button class="drawer-item danger" id="menuCambiarUsuario">
      <span class="di-icon">‚áÑ</span> Cambiar de usuario
    </button>
    <hr class="drawer-sep"/>
    <button class="drawer-item" id="menuContacto">
      <span class="di-icon">‚úâÔ∏è</span> Contacto
    </button>
  </div>
</nav>

<!-- Modal Contacto -->
<div class="modal-overlay" id="modalContacto">
  <div class="modal-box" style="gap:0">
    <button style="position:absolute;top:16px;right:20px;font-size:22px;cursor:pointer;color:var(--muted);background:none;border:none;font-family:inherit" id="btnCerrarContacto">‚úï</button>
    <span class="modal-handle"></span>
    <div style="font-size:20px;font-weight:800;margin-bottom:4px">Contacto</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:16px;line-height:1.4">Te responderemos al correo de tu usuario.</div>
    <label for="cRut">RUT</label>
    <input id="cRut" placeholder="12.345.678-9" maxlength="12"/>
    <div class="field-err-modal" id="err-cRut">RUT inv√°lido</div>
    <label for="cCuentaDestino">Cuenta</label>
    <select id="cCuentaDestino"><option value="">‚Äî Selecciona ‚Äî</option></select>
    <div class="field-err-modal" id="err-cCuentaDestino">Selecciona una cuenta</div>
    <label for="cTipoProblema">Tipo de problema</label>
    <select id="cTipoProblema">
      <option value="">‚Äî Selecciona ‚Äî</option>
      <option value="cuenta_destino">Cuenta Destino</option>
      <option value="modificar_datos">Modificar datos</option>
      <option value="otros">Otros</option>
    </select>
    <div class="field-err-modal" id="err-cTipo">Selecciona un tipo</div>
    <label for="cMensaje">Describe tu problema</label>
    <textarea id="cMensaje" maxlength="500" placeholder="Escribe aqu√≠..."></textarea>
    <div class="char-count"><span id="charCount">0</span>/500</div>
    <div class="field-err-modal" id="err-cMensaje">Escribe al menos 10 caracteres</div>
    <button class="cta" id="btnEnviarContacto">Enviar</button>
    <div id="msg-contacto-err"></div>
  </div>
</div>

<div class="wrap">
  <div class="topbar">
    <button class="hamburger" id="btnHamburger" aria-label="Men√∫"><span></span><span></span><span></span></button>
    <span class="topbar-title">Mi Usuario</span>
  </div>

  <div class="card">
    <div class="card-title">Mis datos</div>

    <div id="stateLoading" class="loading-wrap">
      <div class="skeleton-line"></div>
      <div class="skeleton-line" style="width:55%"></div>
      <div class="skeleton-line" style="width:80%"></div>
    </div>

    <div id="stateNoSession" style="display:none; font-size:14px; color:var(--muted);">
      No hay sesi√≥n activa. <a href="./admin.html" style="color:var(--primary);font-weight:700;">Ir a Inicio</a>
    </div>

    <div id="stateData" style="display:none">
      <div class="rut-pill">
        <div>
          <div class="rut-pill-label">RUT</div>
          <div class="rut-pill-value" id="displayRut"></div>
        </div>
        <span style="font-size:16px">üîí</span>
      </div>

      <label for="editNombre">Nombre</label>
      <input id="editNombre" placeholder="Tu nombre completo"/>

      <label for="editTel">Tel√©fono</label>
      <div class="phone-wrap">
        <input class="phone-prefix" value="+56" readonly/>
        <input id="editTel" placeholder="912345678" inputmode="numeric" maxlength="9"/>
      </div>
      <div class="field-err" id="err-editTel">9 d√≠gitos, empieza en 9</div>

      <label for="editCorreo">Correo</label>
      <input id="editCorreo" placeholder="correo@dominio.cl" inputmode="email"/>
      <div class="field-err" id="err-editCorreo">Formato inv√°lido</div>

      <button class="cta" id="btnGuardar">Guardar cambios</button>
      <div class="msg-ok" id="msgOk">‚úì Guardado. Volviendo al QR‚Ä¶</div>
      <div class="msg-err" id="msgErr"></div>

      <!-- Eliminar (sin t√≠tulo "zona peligrosa") -->
      <div class="delete-section">
        <div class="delete-desc">Eliminar tu usuario borrar√° todos tus datos y cuentas de TuQR. Esta acci√≥n no se puede deshacer.</div>
        <button class="btn-danger" id="btnEliminar">Eliminar mi usuario</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal confirmaci√≥n eliminar -->
<div class="modal-overlay" id="modalEliminar">
  <div class="modal-box">
    <span class="modal-handle"></span>
    <div class="modal-title">¬øEliminar usuario?</div>
    <div class="modal-desc">Se eliminar√°n todos los registros asociados a tu RUT. <strong>Esta acci√≥n no se puede deshacer.</strong></div>
    <button class="btn-confirm-danger" id="btnConfirmarEliminar">S√≠, eliminar mi usuario</button>
    <button class="btn-cancel" id="btnCancelarEliminar">Cancelar</button>
  </div>
</div>

<script>
  emailjs.init('yejdBOXVs6y3d8piR');

  const WORKER_URL  = 'https://tuqr-worker.nestragues.workers.dev/';
  const BASE_URL    = 'https://tuqrapp.github.io/tuqr.github.io/';
  const DATA_URL    = BASE_URL + 'data.json';
  const STORAGE_KEY = 'tuqr_id';

  function clean(s){ return String(s??'').normalize('NFC').replace(/\u00A0/g,' ').replace(/[\u200B-\u200F]/g,'').trim(); }
  function normalizarRut(r){ return r.replace(/[\.\-\s]/g,'').toUpperCase(); }
  function formatRut(raw){
    const r=String(raw||'').replace(/[\.\-\s]/g,''); if(r.length<2) return r;
    return r.slice(0,-1).replace(/\B(?=(\d{3})+(?!\d))/g,'.')+'-'+r.slice(-1);
  }
  function formatearRut(rut){
    const r=rut.replace(/[\.\-\s]/g,''); if(r.length<2) return r;
    return r.slice(0,-1).replace(/\B(?=(\d{3})+(?!\d))/g,'.')+'-'+r.slice(-1);
  }
  function validarRut(rut){
    const r=rut.replace(/[\.\-\s]/g,'').toUpperCase();
    if(!/^\d{7,8}[0-9K]$/.test(r)) return false;
    const cuerpo=r.slice(0,-1),dv=r.slice(-1); let suma=0,mul=2;
    for(let i=cuerpo.length-1;i>=0;i--){suma+=parseInt(cuerpo[i])*mul;mul=mul===7?2:mul+1;}
    const dvE=11-(suma%11); return dv===(dvE===11?'0':dvE===10?'K':String(dvE));
  }
  function abrevTipo(t){ return {'Cuenta Corriente':'Cta Cte','Cuenta Vista':'Cta Vista','Cuenta RUT':'Cta RUT'}[t]||t; }
  function validarEmail(e){ return e.length>0&&/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(e); }
  function validarTel(t){ return /^9\d{8}$/.test(t.replace(/\s/g,'')); }

  let savedId=null, allData={}, datosActuales={};

  // ‚îÄ‚îÄ Drawer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function abrirDrawer(){ document.getElementById('drawer').classList.add('open'); document.getElementById('drawerOverlay').classList.add('open'); }
  function cerrarDrawer(){ document.getElementById('drawer').classList.remove('open'); document.getElementById('drawerOverlay').classList.remove('open'); }

  document.getElementById('btnHamburger').addEventListener('click', abrirDrawer);
  document.getElementById('drawerOverlay').addEventListener('click', cerrarDrawer);
  document.getElementById('menuMisCuentas').addEventListener('click',()=>{ cerrarDrawer(); window.location.href='./app.html'; });
  document.getElementById('menuCambiarUsuario').addEventListener('click',()=>{ cerrarDrawer(); localStorage.removeItem(STORAGE_KEY); window.location.replace('./admin.html?accion=cambiar'); });
  document.getElementById('menuContacto').addEventListener('click',()=>{ cerrarDrawer(); abrirModalContacto(); });

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function init(){
    savedId=localStorage.getItem(STORAGE_KEY);
    if(!savedId){ show('stateLoading',false); show('stateNoSession',true); return; }
    try{ const res=await fetch(DATA_URL+'?ts='+Date.now(),{cache:'no-store'}); allData=await res.json(); }
    catch(e){ allData={}; }
    datosActuales=allData[savedId];
    if(!datosActuales){ show('stateLoading',false); show('stateNoSession',true); return; }

    document.getElementById('displayRut').textContent=formatRut(clean(datosActuales.rut||''));
    document.getElementById('editNombre').value=clean(datosActuales.nombre||'');
    document.getElementById('editTel').value=(datosActuales.telefono||'').replace(/\D/g,'');
    document.getElementById('editCorreo').value=clean(datosActuales.correo||'');
    show('stateLoading',false); show('stateData',true);
  }
  function show(id,v){ document.getElementById(id).style.display=v?'':'none'; }
  init();

  // ‚îÄ‚îÄ Validaci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('editTel').addEventListener('input',function(){
    this.value=this.value.replace(/\D/g,'');
    const ok=validarTel(this.value);
    this.classList.toggle('valid',this.value.length>0&&ok);
    this.classList.toggle('invalid',this.value.length>0&&!ok);
    document.getElementById('err-editTel').classList.toggle('show',this.value.length>0&&!ok);
  });
  document.getElementById('editCorreo').addEventListener('blur',function(){
    const ok=validarEmail(this.value);
    this.classList.toggle('valid',this.value.length>0&&ok);
    this.classList.toggle('invalid',this.value.length>0&&!ok);
    document.getElementById('err-editCorreo').classList.toggle('show',this.value.length>0&&!ok);
  });

  // ‚îÄ‚îÄ Guardar: actualiza todos los registros del RUT, luego vuelve al QR ‚îÄ‚îÄ‚îÄ
  document.getElementById('btnGuardar').addEventListener('click',async function(){
    const msgOk=document.getElementById('msgOk'), msgErr=document.getElementById('msgErr');
    msgOk.style.display='none'; msgErr.style.display='none';

    const nombre   = clean(document.getElementById('editNombre').value);
    const telefono = document.getElementById('editTel').value.replace(/\D/g,'');
    const correo   = clean(document.getElementById('editCorreo').value);

    if(!nombre){ msgErr.textContent='El nombre es obligatorio.'; msgErr.style.display=''; return; }
    if(!validarTel(telefono)){ msgErr.textContent='Tel√©fono inv√°lido (9 d√≠gitos, empieza en 9).'; msgErr.style.display=''; return; }
    if(!validarEmail(correo)){ msgErr.textContent='Correo inv√°lido.'; msgErr.style.display=''; return; }

    this.textContent='Guardando‚Ä¶'; this.disabled=true;

    // Actualizar todos los registros del mismo RUT para propagar nombre/tel/correo
    const rutNorm=normalizarRut(datosActuales.rut||'');
    const idsRut=Object.entries(allData).filter(([,d])=>normalizarRut(d.rut||'')===rutNorm).map(([id])=>id);

    let errores=0;
    for(const idReg of idsRut){
      const d=allData[idReg];
      const payload={ id:idReg, nombre, rut:clean(d.rut||''), banco:clean(d.banco||''), tipoCuenta:clean(d.tipoCuenta||''), numeroCuenta:clean(d.numeroCuenta||''), correo, telefono };
      try{
        const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const data=await res.json();
        if(!res.ok||!data.ok) errores++;
        else allData[idReg]={...d,nombre,telefono,correo}; // actualizar memoria local
      }catch(e){ errores++; }
    }

    this.textContent='Guardar cambios'; this.disabled=false;

    if(errores>0){
      msgErr.textContent='Error al guardar. Intenta de nuevo.'; msgErr.style.display=''; return;
    }

    // Mostrar confirmaci√≥n y redirigir al QR en 1.5s
    msgOk.style.display='';
    setTimeout(()=>{ window.location.replace('./app.html'); }, 1500);
  });

  // ‚îÄ‚îÄ Eliminar usuario ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('btnEliminar').addEventListener('click',()=>{ document.getElementById('modalEliminar').classList.add('open'); });
  document.getElementById('btnCancelarEliminar').addEventListener('click',()=>{ document.getElementById('modalEliminar').classList.remove('open'); });
  document.getElementById('modalEliminar').addEventListener('click',function(e){ if(e.target===this) this.classList.remove('open'); });

  document.getElementById('btnConfirmarEliminar').addEventListener('click',async function(){
    this.textContent='Eliminando‚Ä¶'; this.disabled=true;
    const rutNorm=normalizarRut(datosActuales.rut||'');
    const ids=Object.entries(allData).filter(([,d])=>normalizarRut(d.rut||'')===rutNorm).map(([id])=>id);
    let errores=0;
    for(const idEl of ids){
      try{ const res=await fetch(WORKER_URL,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:idEl})}); if(!res.ok) errores++; }
      catch(e){ errores++; }
    }
    if(errores>0){
      document.getElementById('modalEliminar').classList.remove('open');
      const msgErr=document.getElementById('msgErr');
      msgErr.textContent='Error al eliminar. Intenta de nuevo.'; msgErr.style.display='';
      this.textContent='S√≠, eliminar mi usuario'; this.disabled=false; return;
    }
    localStorage.removeItem(STORAGE_KEY);
    window.location.replace('./admin.html?accion=cambiar');
  });

  // ‚îÄ‚îÄ Modal Contacto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function abrirModalContacto(){
    document.getElementById('modalContacto').classList.add('open');
    document.getElementById('cMensaje').value=''; document.getElementById('charCount').textContent='0';
    document.getElementById('msg-contacto-err').innerHTML=''; document.getElementById('cTipoProblema').value='';
    document.getElementById('btnEnviarContacto').textContent='Enviar'; document.getElementById('btnEnviarContacto').disabled=false;
    ['err-cRut','err-cCuentaDestino','err-cTipo','err-cMensaje'].forEach(i=>{ const el=document.getElementById(i); if(el) el.classList.remove('show'); });
    try{ const res=await fetch(DATA_URL+'?ts='+Date.now(),{cache:'no-store'}); allData=await res.json(); }catch(e){}
    const cRutEl=document.getElementById('cRut'), cCEl=document.getElementById('cCuentaDestino');
    cCEl.innerHTML='<option value="">‚Äî Selecciona ‚Äî</option>'; cRutEl.value=''; cRutEl.classList.remove('valid','invalid');
    if(savedId&&allData[savedId]){
      const d=allData[savedId]; cRutEl.value=d.rut||''; cRutEl.classList.add('valid');
      const rutNorm=normalizarRut(d.rut||'');
      Object.entries(allData).forEach(([id,u])=>{
        if(normalizarRut(u.rut||'')===rutNorm){
          const opt=document.createElement('option'); opt.value=id;
          opt.textContent=`${clean(u.banco)} ¬∑ ${abrevTipo(clean(u.tipoCuenta))} ¬∑ N¬∞${clean(u.numeroCuenta)}`;
          if(id===savedId) opt.selected=true; cCEl.appendChild(opt);
        }
      });
    }
  }
  document.getElementById('btnCerrarContacto').addEventListener('click',()=>{ document.getElementById('modalContacto').classList.remove('open'); });
  document.getElementById('modalContacto').addEventListener('click',function(e){ if(e.target===this) this.classList.remove('open'); });
  document.getElementById('cRut').addEventListener('input',async function(){
    const raw=this.value.replace(/[\.\-\s]/g,''); if(raw.length>=2) this.value=formatearRut(raw);
    const ok=validarRut(this.value);
    this.classList.toggle('valid',this.value.length>0&&ok); this.classList.toggle('invalid',this.value.length>0&&!ok);
    document.getElementById('err-cRut').classList.toggle('show',this.value.length>0&&!ok);
    const sel=document.getElementById('cCuentaDestino'); sel.innerHTML='<option value="">‚Äî Selecciona ‚Äî</option>';
    if(ok){
      try{ const res=await fetch(DATA_URL+'?ts='+Date.now(),{cache:'no-store'}); allData=await res.json(); }catch(e){}
      const rutNorm=normalizarRut(this.value);
      Object.entries(allData).forEach(([id,d])=>{ if(normalizarRut(d.rut||'')===rutNorm){ const opt=document.createElement('option'); opt.value=id; opt.textContent=`${clean(d.banco)} ¬∑ ${abrevTipo(clean(d.tipoCuenta))} ¬∑ N¬∞${clean(d.numeroCuenta)}`; sel.appendChild(opt); } });
    }
  });
  document.getElementById('cMensaje').addEventListener('input',function(){ document.getElementById('charCount').textContent=this.value.length; });
  document.getElementById('btnEnviarContacto').addEventListener('click',async function(){
    const msgErr=document.getElementById('msg-contacto-err'); msgErr.innerHTML=''; let ok=true;
    const rut=document.getElementById('cRut').value.trim(), cd=document.getElementById('cCuentaDestino').value;
    const tipo=document.getElementById('cTipoProblema').value, mensaje=document.getElementById('cMensaje').value.trim();
    if(!validarRut(rut)){document.getElementById('err-cRut').classList.add('show');ok=false;}
    if(!cd){document.getElementById('err-cCuentaDestino').classList.add('show');ok=false;}
    if(!tipo){document.getElementById('err-cTipo').classList.add('show');ok=false;}
    if(mensaje.length<10){document.getElementById('err-cMensaje').classList.add('show');ok=false;}
    if(!ok) return;
    this.textContent='Enviando‚Ä¶'; this.disabled=true;
    const ud=allData[cd]||{};
    try{
      await emailjs.send('service_pbr7qdo','template_emm0576',{from_name:clean(ud.nombre||cd),rut,usuario:cd,tipo_problema:tipo,mensaje,reply_to:ud.correo||'sin-correo@tuqr.app'});
      msgErr.innerHTML='<div style="color:#0a7;font-weight:700;margin-top:10px;">‚úì Mensaje enviado.</div>'; this.textContent='Enviado ‚úì';
    }catch(e){ msgErr.innerHTML='<div style="color:#b00;font-weight:800;margin-top:10px;">Error al enviar.</div>'; this.textContent='Enviar'; this.disabled=false; }
  });
</script>
</body>
</html>
