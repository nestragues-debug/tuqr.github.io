<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#ff7a18"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="TuQR"/>
<link rel="manifest" href="./manifest.json"/>
<link rel="apple-touch-icon" href="./LogoQ_transparent.png"/>
<title>TuQR</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
  :root{
    --primary:#ff7a18; --accent:#ffd400; --bg:#f2f3f5; --card:#ffffff;
    --text:#1a1a1a; --muted:#5a5a5a; --border:rgba(0,0,0,.08);
    --shadow:0 10px 24px rgba(0,0,0,.08); --radius:18px;
  }
  *{ box-sizing:border-box; margin:0; padding:0; }
  html,body{
    height:100%; font-family:"Poppins",system-ui,sans-serif;
    background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
  }
  body{
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    padding:20px 16px; gap:16px; overscroll-behavior:none; min-height:100vh;
  }
  .brand img{ width:160px; height:auto; display:block; filter:drop-shadow(0 4px 8px rgba(0,0,0,.10)); }
  .card{
    width:100%; max-width:360px; background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); padding:24px 20px 28px; box-shadow:var(--shadow);
    position:relative; overflow:hidden; display:flex; flex-direction:column; align-items:center; gap:16px;
  }
  .card::before{
    content:""; position:absolute; top:0; left:0; right:0; height:8px;
    background:linear-gradient(90deg,rgba(255,212,0,.95),rgba(255,122,24,.95));
  }
  .comercio-nombre{ font-size:18px; font-weight:800; text-align:center; margin-top:4px; }
  .banco-nombre{ font-size:13px; font-weight:600; color:var(--muted); text-align:center; margin-top:-8px; }
  .qr-box{
    background:#fff; border-radius:16px; padding:16px;
    box-shadow:0 4px 16px rgba(0,0,0,.07); display:flex; align-items:center; justify-content:center;
  }
  .qr-box canvas{ border-radius:8px; display:block; }

  /* Recuadro de datos copiables */
  .datos-box{
    width:100%; background:#f7f7f7; border:1px solid rgba(0,0,0,.10);
    border-radius:14px; padding:14px; cursor:pointer;
    -webkit-tap-highlight-color:transparent;
    transition:background .1s;
  }
  .datos-box:active{ background:#efefef; }
  .datos-pre{
    white-space:pre-wrap; word-break:break-word; font-size:12px; line-height:1.55;
    font-family:inherit; color:var(--text); user-select:all; -webkit-user-select:all;
    margin:0;
  }
  .datos-copy-label{
    font-size:11px; font-weight:700; color:var(--primary);
    margin-top:8px; display:block; text-align:right;
  }
  .datos-ok{
    font-size:11px; font-weight:700; color:#0a7;
    margin-top:8px; display:none; text-align:right;
  }

  .badge{
    display:flex; align-items:center; gap:6px; font-weight:700; font-size:12px;
    color:rgba(26,26,26,.85); background:rgba(255,212,0,.18); border:1px solid rgba(255,212,0,.32);
    padding:6px 12px; border-radius:999px;
  }
  .badge .dot{
    width:8px; height:8px; border-radius:999px; background:var(--accent);
    box-shadow:0 0 0 3px rgba(255,212,0,.2); animation:pulse 2s infinite;
  }
  @keyframes pulse{
    0%,100%{ box-shadow:0 0 0 3px rgba(255,212,0,.2); }
    50%{ box-shadow:0 0 0 6px rgba(255,212,0,.05); }
  }
  .btn-cambiar{
    width:100%; padding:13px; font-size:14px; font-weight:800; font-family:inherit;
    border:2px solid var(--primary); border-radius:12px; cursor:pointer;
    color:var(--primary); background:rgba(255,122,24,.06);
    -webkit-tap-highlight-color:transparent; transition:background .12s, transform .06s;
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn-cambiar:active{ transform:translateY(1px); background:rgba(255,122,24,.12); }
  .btn-nueva-cuenta{
    width:100%; padding:14px; font-size:15px; font-weight:800; font-family:inherit;
    border:0; border-radius:12px; cursor:pointer; color:#fff; background:var(--primary);
    box-shadow:0 6px 16px rgba(255,122,24,.30); -webkit-tap-highlight-color:transparent;
    transition:transform .06s, filter .06s;
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn-nueva-cuenta:active{ transform:translateY(1px); filter:brightness(.96); }
  .link-contacto{
    font-size:13px; font-weight:700; color:var(--primary); cursor:pointer;
    text-decoration:underline; background:none; border:none; font-family:inherit;
  }
  #screenElegirCuenta{
    width:100%; max-width:360px; display:none; flex-direction:column; align-items:center; gap:16px;
  }
  #screenElegirCuenta .card{ gap:14px; width:100%; align-items:stretch; }
  #screenReactivar{
    width:100%; max-width:360px; display:none; flex-direction:column; align-items:center; gap:16px;
  }
  #screenReactivar .card{ gap:14px; width:100%; }
  #screenElegirReact{
    width:100%; max-width:360px; display:none; flex-direction:column; align-items:center; gap:16px;
  }
  #screenElegirReact .card{ gap:14px; width:100%; }
  .react-title{ font-size:18px; font-weight:800; margin-top:4px; text-align:center; }
  .react-sub{ font-size:13px; color:var(--muted); text-align:center; line-height:1.4; }
  .r-label{ font-weight:700; font-size:13px; color:var(--muted); margin-bottom:5px; display:block; }
  .r-input{
    width:100%; padding:12px; font-size:15px; font-family:inherit;
    border:1.5px solid rgba(0,0,0,.12); border-radius:12px; outline:none; background:#fff;
    transition:border-color .15s, box-shadow .15s; -webkit-appearance:none;
  }
  .r-input:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(255,122,24,.12); }
  .r-input.invalid{ border-color:#e00; background:#fff8f8; }
  .r-input.valid{ border-color:#0a7; background:#f5fbf8; }
  .phone-wrap{ display:flex; gap:8px; width:100%; }
  .phone-prefix{
    width:72px; flex-shrink:0; padding:11px 10px; font-size:14px; font-family:inherit;
    border:1.5px solid rgba(0,0,0,.12); border-radius:12px;
    background:#f7f7f7; color:var(--muted); text-align:center; outline:none;
  }
  .phone-wrap .r-input{ flex:1; }
  .field-err{ color:#c00; font-size:12px; font-weight:600; display:none; margin-top:4px; }
  .field-err.show{ display:block; }
  .cuenta-destino-list{ display:flex; flex-direction:column; gap:10px; width:100%; }
  .cuenta-destino-item{
    padding:14px 16px; border-radius:14px; cursor:pointer;
    border:2px solid var(--border); background:#fff; display:flex; flex-direction:column; gap:2px;
    -webkit-tap-highlight-color:transparent; transition:border-color .12s, background .12s;
  }
  .cuenta-destino-item:active{ background:#f7f7f7; }
  .cuenta-destino-item:hover{ border-color:var(--primary); background:rgba(255,122,24,.04); }
  .cuenta-destino-item.activa{ border-color:var(--primary); background:rgba(255,122,24,.04); }
  .cuenta-destino-nombre{ font-size:15px; font-weight:800; color:var(--text); }
  .cuenta-destino-id{ font-size:12px; font-weight:600; color:var(--muted); }
  .cuenta-destino-badge{ font-size:11px; font-weight:700; color:var(--primary); margin-top:3px; }
  .link-back{
    font-size:13px; font-weight:700; color:var(--muted); cursor:pointer;
    text-align:center; display:block; margin-top:4px; background:none; border:none; font-family:inherit;
  }
  .link-back:active{ color:var(--primary); }
  .cta{
    width:100%; padding:13px; font-size:15px; font-weight:800; font-family:inherit;
    border:0; border-radius:12px; cursor:pointer; color:#fff; background:var(--primary);
    box-shadow:0 6px 12px rgba(255,122,24,.22); -webkit-tap-highlight-color:transparent;
    transition:transform .06s ease, filter .06s ease;
  }
  .cta:active{ transform:translateY(1px); filter:brightness(.98); }
  .modal-overlay{
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);
    z-index:1000; align-items:flex-end; justify-content:center;
  }
  .modal-overlay.open{ display:flex; }
  .modal-box{
    background:#fff; border-radius:24px 24px 0 0; padding:28px 20px 40px;
    width:100%; max-width:480px; max-height:90vh; overflow-y:auto;
    box-shadow:0 -8px 32px rgba(0,0,0,.15); animation:slideUp .25s ease;
  }
  @keyframes slideUp{ from{ transform:translateY(100%); } to{ transform:translateY(0); } }
  .modal-handle{ width:40px; height:4px; border-radius:999px; background:#ddd; margin:0 auto 20px; display:block; }
  .modal-title{ font-size:20px; font-weight:800; margin-bottom:4px; }
  .modal-sub{ font-size:13px; color:var(--muted); margin-bottom:16px; line-height:1.4; }
  .modal-close{
    position:absolute; top:16px; right:20px; font-size:22px; cursor:pointer;
    color:var(--muted); background:none; border:none; font-family:inherit;
  }
  label{ font-weight:700; font-size:13px; color:var(--muted); margin-top:14px; display:block; margin-bottom:5px; }
  input, select, textarea{
    width:100%; padding:11px 12px; font-size:14px; font-family:inherit;
    border:1.5px solid rgba(0,0,0,.12); border-radius:12px; background:#fff; color:var(--text);
    outline:none; transition:border-color .15s, box-shadow .15s; -webkit-appearance:none; appearance:none;
  }
  input:focus, select:focus, textarea:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(255,122,24,.12); }
  input.invalid{ border-color:#e00; background:#fff8f8; }
  input.valid{ border-color:#0a7; background:#f5fbf8; }
  textarea{ resize:vertical; min-height:100px; }
  .char-count{ font-size:11px; color:var(--muted); text-align:right; margin-top:3px; }
  .err{
    margin-top:12px; font-weight:800; padding:10px 12px; border-radius:12px; font-size:14px;
    color:#b00; background:rgba(190,0,0,.08); border:1px solid rgba(190,0,0,.14);
  }
</style>
</head>
<body>

<!-- Vista QR -->
<div id="main" style="display:none; flex-direction:column; align-items:center; width:100%; max-width:360px; gap:16px;">
  <div class="brand"><img src="./TuQRLogo.png" alt="TuQR"/></div>
  <div class="card">
    <div class="comercio-nombre" id="nombreEl">Cargando…</div>
    <div class="banco-nombre" id="bancoEl"></div>
    <div class="qr-box"><canvas id="qrCanvas"></canvas></div>
    <div class="badge"><span class="dot"></span> QR activo</div>

    <!-- Recuadro copiable -->
    <div class="datos-box" id="datosBox" onclick="copiarDatosQR()">
      <pre class="datos-pre" id="datosPreEl"></pre>
      <span class="datos-copy-label" id="datosCopyLabel">Tocar para copiar datos</span>
      <span class="datos-ok" id="datosOkEl">✓ Copiado</span>
    </div>

    <button class="btn-cambiar" id="btnCambiarCuenta">⇄ Cambiar cuenta destino</button>
    <button class="btn-nueva-cuenta" id="btnNuevaCuenta">✨ Crear nueva cuenta destino</button>
    <button class="link-contacto" id="btnContactoApp">Contacto</button>
  </div>
</div>

<!-- Elegir cuenta destino activa -->
<div id="screenElegirCuenta">
  <div class="brand"><img src="./TuQRLogo.png" alt="TuQR"/></div>
  <div class="card">
    <div class="react-title">Mis cuentas destino</div>
    <div class="react-sub">Selecciona qué cuenta destino quieres mostrar en tu QR.</div>
    <button class="btn-nueva-cuenta" id="btnNuevaCuentaDesdeListado">✨ Crear nueva cuenta destino</button>
    <div class="cuenta-destino-list" id="listaCuentasDestino"></div>
    <button class="link-back" id="backFromElegirCuenta">← Volver</button>
  </div>
</div>

<!-- Reactivar sesión -->
<div id="screenReactivar">
  <div class="brand"><img src="./TuQRLogo.png" alt="TuQR"/></div>
  <div class="card">
    <div class="react-title">Activa TuQR</div>
    <div class="react-sub">Ingresa tu RUT y teléfono para acceder a tu cuenta destino.</div>
    <div style="width:100%">
      <label class="r-label">RUT</label>
      <input class="r-input" id="reactRut" placeholder="12.345.678-9" maxlength="12"/>
      <div class="field-err" id="err-reactRut">RUT inválido</div>
    </div>
    <div style="width:100%">
      <label class="r-label">Teléfono</label>
      <div class="phone-wrap">
        <input class="phone-prefix" value="+56" readonly/>
        <input class="r-input" id="reactTel" placeholder="912345678" inputmode="numeric" maxlength="12"/>
      </div>
      <div class="field-err" id="err-reactTel">Número inválido</div>
    </div>
    <div class="field-err" id="err-reactGeneral">No encontramos un usuario con esos datos.</div>
    <button class="cta" id="btnReactivar">Activar</button>
    <button class="link-contacto" id="btnContactoReact" style="margin-top:14px">Contacto</button>
  </div>
</div>

<!-- Elegir cuenta destino al reactivar (múltiples) -->
<div id="screenElegirReact">
  <div class="brand"><img src="./TuQRLogo.png" alt="TuQR"/></div>
  <div class="card">
    <div class="react-title">Elige tu cuenta destino</div>
    <div class="react-sub">Encontramos más de una cuenta destino. ¿Cuál quieres activar?</div>
    <div class="cuenta-destino-list" id="listaCuentasReact"></div>
    <button class="link-back" id="backFromElegirReact">← Volver</button>
  </div>
</div>

<!-- Modal Contacto -->
<div class="modal-overlay" id="modalContacto">
  <div class="modal-box" style="position:relative">
    <button class="modal-close" id="btnCerrarModal">✕</button>
    <span class="modal-handle"></span>
    <div class="modal-title">Contacto</div>
    <div class="modal-sub">Te responderemos al correo de tu usuario.</div>
    <label for="cRut">RUT</label>
    <input id="cRut" placeholder="12.345.678-9" maxlength="12"/>
    <div class="field-err" id="err-cRut">RUT inválido</div>
    <label for="cCuentaDestino">Cuenta Destino</label>
    <select id="cCuentaDestino"><option value="">— Selecciona —</option></select>
    <div class="field-err" id="err-cCuentaDestino">Selecciona una cuenta destino</div>
    <label for="cTipo">Tipo de problema</label>
    <select id="cTipo">
      <option value="">— Selecciona —</option>
      <option value="cuenta_destino">Cuenta Destino</option>
      <option value="modificar_datos">Modificar datos</option>
      <option value="otros">Otros</option>
    </select>
    <div class="field-err" id="err-cTipo">Selecciona un tipo</div>
    <label for="cMensaje">Describe tu problema</label>
    <textarea id="cMensaje" maxlength="500" placeholder="Escribe aquí..."></textarea>
    <div class="char-count"><span id="charCount">0</span>/500</div>
    <div class="field-err" id="err-cMensaje">Escribe al menos 10 caracteres</div>
    <button class="cta" id="btnEnviarContacto" style="margin-top:20px">Enviar</button>
    <div id="msg-contacto-err"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  emailjs.init('yejdBOXVs6y3d8piR');

  const BASE_URL    = 'https://tuqrapp.github.io/tuqr.github.io/';
  const DATA_URL    = BASE_URL + 'data.json';
  const STORAGE_KEY = 'tuqr_id';

  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

  function clean(s){
    return String(s??'').normalize('NFC').replace(/\u00A0/g,' ').replace(/[\u200B-\u200F\uFEFF]/g,'').trim();
  }
  function validarRut(rut){
    const r=rut.replace(/[\.\-\s]/g,'').toUpperCase();
    if(!/^\d{7,8}[0-9K]$/.test(r)) return false;
    const cuerpo=r.slice(0,-1), dv=r.slice(-1);
    let suma=0, mul=2;
    for(let i=cuerpo.length-1;i>=0;i--){ suma+=parseInt(cuerpo[i])*mul; mul=mul===7?2:mul+1; }
    const dvE=11-(suma%11);
    return dv===(dvE===11?'0':dvE===10?'K':String(dvE));
  }
  function formatearRut(rut){
    const r=rut.replace(/[\.\-\s]/g,'');
    if(r.length<2) return r;
    return r.slice(0,-1).replace(/\B(?=(\d{3})+(?!\d))/g,'.')+'-'+r.slice(-1);
  }
  function normalizarRut(rut){ return rut.replace(/[\.\-\s]/g,'').toUpperCase(); }
  function validarTel(t){ return /^\d{8,12}$/.test(t.replace(/\s/g,'')); }

  function formatRutDisplay(raw){
    const r=raw.replace(/[\.\-\s]/g,'');
    if(r.length<2) return r;
    return r.slice(0,-1).replace(/\B(?=(\d{3})+(?!\d))/g,'.')+'-'+r.slice(-1);
  }

  function generarQR(url){
    const canvas=document.getElementById('qrCanvas');
    const size=Math.min(300, window.innerWidth-100);
    canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
    const tmp=document.createElement('div');
    new QRCode(tmp,{text:url,width:size,height:size,correctLevel:QRCode.CorrectLevel.M});
    setTimeout(()=>{
      const src=tmp.querySelector('canvas');
      if(src){ canvas.width=src.width; canvas.height=src.height; canvas.getContext('2d').drawImage(src,0,0); }
    },100);
  }

  function copyText(text){
    const payload=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    if(navigator.clipboard && typeof navigator.clipboard.writeText==='function'){
      return navigator.clipboard.writeText(payload).then(()=>true).catch(()=>{
        if(window.ClipboardItem){
          return navigator.clipboard.write([
            new ClipboardItem({'text/plain':Promise.resolve(new Blob([payload],{type:'text/plain'}))})
          ]).then(()=>true).catch(()=>legacyCopy(payload));
        }
        return legacyCopy(payload);
      });
    }
    return Promise.resolve(legacyCopy(payload));
  }

  function legacyCopy(text){
    try{
      const ta=document.createElement('textarea');
      ta.value=text; ta.setAttribute('readonly','');
      ta.style.cssText='position:fixed;top:0;left:0;width:2em;height:2em;padding:0;border:none;outline:none;background:transparent;opacity:0;pointer-events:none;z-index:-1';
      document.body.appendChild(ta); ta.focus({preventScroll:true}); ta.select(); ta.setSelectionRange(0,ta.value.length);
      const ok=document.execCommand('copy'); document.body.removeChild(ta);
      return ok;
    }catch(_){ return false; }
  }

  let allData={};
  let usuarioActivo=null;
  let cachedDatosText='';
  let datosOkTimer=null;

  function buildDatosText(d){
    const nombre=clean(d.nombre);
    const rutRaw=clean(d.rut);
    const rutDisplay=formatRutDisplay(rutRaw);
    const banco=clean(d.banco);
    const tipo=clean(d.tipoCuenta);
    const numero=clean(d.numeroCuenta);
    const correo=d.correo?clean(d.correo):'';
    const lines=[
      `Nombre: ${nombre}`,
      `RUT: ${rutDisplay}`,
      `Banco: ${banco}`,
      `Tipo de cuenta: ${tipo}`,
      `N° de cuenta: ${numero}`
    ];
    if(correo) lines.push(`Correo: ${correo}`);
    return lines.join('\n');
  }

  function copiarDatosQR(){
    if(!cachedDatosText) return;
    copyText(cachedDatosText).then(ok=>{
      const label=document.getElementById('datosCopyLabel');
      const okEl=document.getElementById('datosOkEl');
      if(ok){
        label.style.display='none'; okEl.style.display='block';
        if(datosOkTimer) clearTimeout(datosOkTimer);
        datosOkTimer=setTimeout(()=>{ label.style.display=''; okEl.style.display='none'; },1800);
      }
    });
  }

  async function cargarData(){
    try{
      const res=await fetch(DATA_URL+'?ts='+Date.now(),{cache:'no-store'});
      allData=await res.json();
    }catch(e){ allData={}; }
    return allData;
  }

  async function mostrarApp(id){
    try{
      await cargarData();
      const d=allData[id];
      if(!d) return false;
      usuarioActivo={rut:normalizarRut(d.rut||''), tel:(d.telefono||'').replace(/\D/g,'')};
      const qrUrl=BASE_URL+'?id='+encodeURIComponent(id);
      document.getElementById('nombreEl').textContent=clean(d.nombre);
      document.getElementById('bancoEl').textContent=clean(d.banco)+' · '+clean(d.tipoCuenta);
      document.title='TuQR — '+clean(d.nombre);
      generarQR(qrUrl);

      // Datos copiables
      cachedDatosText=buildDatosText(d);
      document.getElementById('datosPreEl').textContent=cachedDatosText;

      document.getElementById('main').style.display='flex';
      document.getElementById('screenReactivar').style.display='none';
      document.getElementById('screenElegirReact').style.display='none';
      document.getElementById('screenElegirCuenta').style.display='none';
      return true;
    }catch(e){ return false; }
  }

  /* ── Cambiar cuenta destino ── */
  async function mostrarElegirCuenta(){
    await cargarData();
    const savedId=localStorage.getItem(STORAGE_KEY);
    const lista=document.getElementById('listaCuentasDestino');
    lista.innerHTML='';
    if(usuarioActivo){
      Object.entries(allData)
        .filter(([id,d])=>normalizarRut(d.rut||'')===usuarioActivo.rut&&(d.telefono||'').replace(/\D/g,'')===usuarioActivo.tel)
        .forEach(([id,d])=>{
          const item=document.createElement('div');
          const esActiva=id===savedId;
          item.className='cuenta-destino-item'+(esActiva?' activa':'');
          item.innerHTML=`
            <div class="cuenta-destino-nombre">${clean(d.nombre)}</div>
            <div class="cuenta-destino-id">${clean(d.banco)} · ${clean(d.tipoCuenta)}</div>
            ${esActiva?'<div class="cuenta-destino-badge">✓ Activa ahora</div>':''}
          `;
          item.addEventListener('click',()=>{
            localStorage.setItem(STORAGE_KEY,id);
            mostrarApp(id);
          });
          lista.appendChild(item);
        });
    }
    document.getElementById('main').style.display='none';
    document.getElementById('screenElegirCuenta').style.display='flex';
  }

  document.getElementById('btnCambiarCuenta').addEventListener('click',mostrarElegirCuenta);
  document.getElementById('backFromElegirCuenta').addEventListener('click',()=>{
    document.getElementById('screenElegirCuenta').style.display='none';
    document.getElementById('main').style.display='flex';
  });

  function irACrearCuentaDestino(){ window.location.replace('./admin.html?accion=nueva_cuenta'); }
  document.getElementById('btnNuevaCuenta').addEventListener('click',irACrearCuentaDestino);
  document.getElementById('btnNuevaCuentaDesdeListado').addEventListener('click',irACrearCuentaDestino);

  /* ── Init ── */
  async function init(){
    const savedId=localStorage.getItem(STORAGE_KEY);
    if(savedId){
      const ok=await mostrarApp(savedId);
      if(ok) return;
      localStorage.removeItem(STORAGE_KEY);
    }
    document.getElementById('screenReactivar').style.display='flex';
  }

  /* ── Reactivar ── */
  const reactRutInput=document.getElementById('reactRut');
  const reactTelInput=document.getElementById('reactTel');

  reactRutInput.addEventListener('input',function(){
    const raw=this.value.replace(/[\.\-\s]/g,'');
    if(raw.length>=2) this.value=formatearRut(raw);
    const ok=validarRut(this.value);
    this.classList.toggle('valid',this.value.length>0&&ok);
    this.classList.toggle('invalid',this.value.length>0&&!ok);
    document.getElementById('err-reactRut').classList.toggle('show',this.value.length>0&&!ok);
    document.getElementById('err-reactGeneral').classList.remove('show');
  });
  reactTelInput.addEventListener('input',function(){
    this.value=this.value.replace(/\D/g,'');
    const ok=validarTel(this.value);
    this.classList.toggle('valid',this.value.length>0&&ok);
    this.classList.toggle('invalid',this.value.length>0&&!ok);
    document.getElementById('err-reactTel').classList.toggle('show',this.value.length>0&&!ok);
  });

  document.getElementById('backFromElegirReact').addEventListener('click',()=>{
    document.getElementById('screenElegirReact').style.display='none';
    document.getElementById('screenReactivar').style.display='flex';
  });

  document.getElementById('btnReactivar').addEventListener('click',async function(){
    const rutVal=reactRutInput.value.trim();
    const telVal=reactTelInput.value.replace(/\D/g,'');
    const errGen=document.getElementById('err-reactGeneral');
    errGen.classList.remove('show');
    if(!validarRut(rutVal)){reactRutInput.classList.add('invalid');document.getElementById('err-reactRut').classList.add('show');return;}
    if(!validarTel(telVal)){reactTelInput.classList.add('invalid');document.getElementById('err-reactTel').classList.add('show');return;}
    this.textContent='Verificando…'; this.disabled=true;
    try{
      await cargarData();
      const rutNorm=normalizarRut(rutVal);
      const matches=Object.entries(allData).filter(([id,d])=>
        normalizarRut(d.rut||'')===rutNorm&&(d.telefono||'').replace(/\D/g,'')===telVal
      );
      if(matches.length===0){
        errGen.classList.add('show'); this.textContent='Activar'; this.disabled=false;
      } else if(matches.length===1){
        localStorage.setItem(STORAGE_KEY,matches[0][0]);
        await mostrarApp(matches[0][0]);
        this.textContent='Activar'; this.disabled=false;
      } else {
        const list=document.getElementById('listaCuentasReact');
        list.innerHTML='';
        matches.forEach(([id,d])=>{
          const item=document.createElement('div');
          item.className='cuenta-destino-item';
          item.innerHTML=`<div class="cuenta-destino-nombre">${clean(d.nombre)}</div><div class="cuenta-destino-id">${clean(d.banco)} · ${clean(d.tipoCuenta)}</div>`;
          item.addEventListener('click',async()=>{
            localStorage.setItem(STORAGE_KEY,id);
            await mostrarApp(id);
            document.getElementById('screenElegirReact').style.display='none';
          });
          list.appendChild(item);
        });
        document.getElementById('screenReactivar').style.display='none';
        document.getElementById('screenElegirReact').style.display='flex';
        this.textContent='Activar'; this.disabled=false;
      }
    }catch(e){
      errGen.textContent='Error al conectar. Intenta de nuevo.';
      errGen.classList.add('show'); this.textContent='Activar'; this.disabled=false;
    }
  });

  /* ── Modal Contacto ── */
  async function abrirModalContacto(){
    document.getElementById('modalContacto').classList.add('open');
    document.getElementById('cMensaje').value='';
    document.getElementById('charCount').textContent='0';
    document.getElementById('msg-contacto-err').innerHTML='';
    document.getElementById('cTipo').value='';
    document.getElementById('btnEnviarContacto').textContent='Enviar';
    document.getElementById('btnEnviarContacto').disabled=false;
    ['err-cRut','err-cCuentaDestino','err-cTipo','err-cMensaje'].forEach(id=>{document.getElementById(id).classList.remove('show');});
    const savedId=localStorage.getItem(STORAGE_KEY);
    await cargarData();
    const cRutEl=document.getElementById('cRut');
    const cCuentaDestinoEl=document.getElementById('cCuentaDestino');
    cCuentaDestinoEl.innerHTML='<option value="">— Selecciona —</option>';
    cRutEl.value=''; cRutEl.classList.remove('valid','invalid');
    if(savedId&&allData[savedId]){
      const d=allData[savedId];
      cRutEl.value=d.rut||''; cRutEl.classList.add('valid');
      const rutNorm=normalizarRut(d.rut||'');
      Object.entries(allData).forEach(([id,u])=>{
        if(normalizarRut(u.rut||'')===rutNorm){
          const opt=document.createElement('option');
          opt.value=id; opt.textContent=`${clean(u.nombre)} — ${clean(u.banco)}`;
          if(id===savedId) opt.selected=true;
          cCuentaDestinoEl.appendChild(opt);
        }
      });
    }
  }

  function cerrarModal(){ document.getElementById('modalContacto').classList.remove('open'); }
  document.getElementById('btnCerrarModal').addEventListener('click',cerrarModal);
  document.getElementById('modalContacto').addEventListener('click',function(e){ if(e.target===this) cerrarModal(); });

  ['btnContactoApp','btnContactoReact'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('click',abrirModalContacto);
  });

  document.getElementById('cRut').addEventListener('input',async function(){
    const raw=this.value.replace(/[\.\-\s]/g,'');
    if(raw.length>=2) this.value=formatearRut(raw);
    const ok=validarRut(this.value);
    this.classList.toggle('valid',this.value.length>0&&ok);
    this.classList.toggle('invalid',this.value.length>0&&!ok);
    document.getElementById('err-cRut').classList.toggle('show',this.value.length>0&&!ok);
    const sel=document.getElementById('cCuentaDestino');
    sel.innerHTML='<option value="">— Selecciona —</option>';
    if(ok){
      await cargarData();
      const rutNorm=normalizarRut(this.value);
      Object.entries(allData).forEach(([id,d])=>{
        if(normalizarRut(d.rut||'')===rutNorm){
          const opt=document.createElement('option');
          opt.value=id; opt.textContent=`${clean(d.nombre)} — ${clean(d.banco)}`;
          sel.appendChild(opt);
        }
      });
    }
  });

  document.getElementById('cMensaje').addEventListener('input',function(){ document.getElementById('charCount').textContent=this.value.length; });

  document.getElementById('btnEnviarContacto').addEventListener('click',async function(){
    const msgErr=document.getElementById('msg-contacto-err');
    msgErr.innerHTML='';
    let ok=true;
    const rut=document.getElementById('cRut').value.trim();
    const cuentaDestino=document.getElementById('cCuentaDestino').value;
    const tipo=document.getElementById('cTipo').value;
    const mensaje=document.getElementById('cMensaje').value.trim();
    if(!validarRut(rut)){document.getElementById('err-cRut').classList.add('show');ok=false;}
    if(!cuentaDestino){document.getElementById('err-cCuentaDestino').classList.add('show');ok=false;}
    if(!tipo){document.getElementById('err-cTipo').classList.add('show');ok=false;}
    if(mensaje.length<10){document.getElementById('err-cMensaje').classList.add('show');ok=false;}
    if(!ok) return;
    this.textContent='Enviando…'; this.disabled=true;
    const userData=allData[cuentaDestino]||{};
    const replyTo=userData.correo||'sin-correo@tuqr.app';
    const nombreUsuario=clean(userData.nombre||cuentaDestino);
    try{
      await emailjs.send('service_pbr7qdo','template_emm0576',{
        from_name:nombreUsuario, rut, usuario:cuentaDestino, tipo_problema:tipo, mensaje, reply_to:replyTo
      });
      msgErr.innerHTML='<div style="color:#0a7;font-weight:700;margin-top:10px;">✓ Mensaje enviado. Te responderemos pronto.</div>';
      this.textContent='Enviado ✓';
    }catch(e){
      msgErr.innerHTML='<div class="err">Error al enviar. Intenta de nuevo.</div>';
      this.textContent='Enviar'; this.disabled=false;
    }
  });

  init();
</script>
</body>
</html>
