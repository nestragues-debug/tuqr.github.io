<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#ff7a18"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="TuQR"/>
<link rel="manifest" href="./manifest.json"/>
<link rel="apple-touch-icon" href="./LogoQ_transparent.png"/>
<title>TuQR</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
  :root{
    --primary:#ff7a18; --accent:#ffd400; --bg:#f2f3f5; --card:#ffffff;
    --text:#1a1a1a; --muted:#5a5a5a; --border:rgba(0,0,0,.08);
    --shadow:0 10px 24px rgba(0,0,0,.08); --radius:18px;
  }
  *{ box-sizing:border-box; margin:0; padding:0; }
  html,body{
    height:100%; font-family:"Poppins",system-ui,sans-serif;
    background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
  }
  body{
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    padding:20px 16px; gap:16px; overscroll-behavior:none; min-height:100vh;
  }
  .brand img{ width:160px; height:auto; display:block; filter:drop-shadow(0 4px 8px rgba(0,0,0,.10)); }
  .card{
    width:100%; max-width:360px; background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); padding:24px 20px 28px; box-shadow:var(--shadow);
    position:relative; overflow:hidden; display:flex; flex-direction:column; align-items:center; gap:16px;
  }
  .card::before{
    content:""; position:absolute; top:0; left:0; right:0; height:8px;
    background:linear-gradient(90deg,rgba(255,212,0,.95),rgba(255,122,24,.95));
  }
  .qr-box{
    background:#fff; border-radius:16px; padding:16px;
    box-shadow:0 4px 16px rgba(0,0,0,.07); display:flex; align-items:center; justify-content:center;
  }
  .qr-box canvas{ border-radius:8px; display:block; }

  /* Recuadro datos mini — vista QR */
  .datos-mini{
    width:100%; background:#f7f7f7; border:1px solid rgba(0,0,0,.10);
    border-radius:12px; padding:10px 12px; cursor:pointer;
    -webkit-tap-highlight-color:transparent; transition:background .1s;
    display:flex; flex-direction:column; gap:5px;
  }
  .datos-mini:active{ background:#efefef; }
  .datos-mini pre{
    white-space:pre-wrap; word-break:break-word;
    font-size:10px; line-height:1.5; font-family:inherit;
    color:var(--muted); margin:0; user-select:all; -webkit-user-select:all;
  }
  .datos-mini-footer{
    display:flex; align-items:center; justify-content:space-between; gap:6px;
  }
  .datos-mini-hint{ font-size:10px; color:#aaa; }
  .datos-mini-label{ font-size:10px; font-weight:700; color:var(--primary); }
  .datos-mini-ok{ font-size:10px; font-weight:700; color:#0a7; display:none; }

  .btn-gestion{
    width:100%; padding:14px; font-size:15px; font-weight:800; font-family:inherit;
    border:0; border-radius:12px; cursor:pointer; color:#fff; background:var(--primary);
    box-shadow:0 6px 16px rgba(255,122,24,.30); -webkit-tap-highlight-color:transparent;
    transition:transform .06s, filter .06s;
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn-gestion:active{ transform:translateY(1px); filter:brightness(.96); }
  .link-contacto{
    font-size:13px; font-weight:700; color:var(--primary); cursor:pointer;
    text-decoration:underline; background:none; border:none; font-family:inherit;
  }
  .link-cerrar-sesion{
    font-size:11px; color:#aaa; cursor:pointer; background:none; border:none;
    font-family:inherit; text-decoration:none;
  }
  .link-cerrar-sesion:active{ color:#888; }

  /* Pantallas secundarias */
  #screenGestion, #screenReactivar, #screenElegirReact, #screenEspera{
    width:100%; max-width:360px; display:none; flex-direction:column; align-items:center; gap:16px;
  }
  #screenGestion .card, #screenReactivar .card, #screenElegirReact .card{
    gap:14px; width:100%; align-items:stretch;
  }
  .react-title{ font-size:18px; font-weight:800; margin-top:4px; text-align:center; }
  .react-sub{ font-size:13px; color:var(--muted); text-align:center; line-height:1.4; }
  .identity-box{
    background:#f7f7f7; border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:14px 16px;
    display:flex; flex-direction:column; gap:4px;
  }
  .identity-label{ font-size:11px; font-weight:700; color:var(--muted); }
  .identity-value{ font-size:15px; font-weight:800; color:var(--text); }
  .identity-sub{ font-size:12px; color:var(--muted); margin-top:1px; }
  .section-title{
    font-size:13px; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:.5px;
  }
  .r-label{ font-weight:700; font-size:13px; color:var(--muted); margin-bottom:5px; display:block; }
  .r-input{
    width:100%; padding:12px; font-size:15px; font-family:inherit;
    border:1.5px solid rgba(0,0,0,.12); border-radius:12px; outline:none; background:#fff;
    transition:border-color .15s, box-shadow .15s; -webkit-appearance:none;
  }
  .r-input:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(255,122,24,.12); }
  .r-input.invalid{ border-color:#e00; background:#fff8f8; }
  .r-input.valid{ border-color:#0a7; background:#f5fbf8; }
  .r-select{
    width:100%; padding:12px; font-size:14px; font-family:inherit;
    border:1.5px solid rgba(0,0,0,.12); border-radius:12px; outline:none; background:#fff;
    -webkit-appearance:none; appearance:none; transition:border-color .15s, box-shadow .15s;
  }
  .r-select:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(255,122,24,.12); }
  .r-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; width:100%; }
  .phone-wrap{ display:flex; gap:8px; width:100%; }
  .phone-prefix{
    width:72px; flex-shrink:0; padding:11px 10px; font-size:14px; font-family:inherit;
    border:1.5px solid rgba(0,0,0,.12); border-radius:12px;
    background:#f7f7f7; color:var(--muted); text-align:center; outline:none;
  }
  .phone-wrap .r-input{ flex:1; }
  .field-err{ color:#c00; font-size:12px; font-weight:600; display:none; margin-top:4px; }
  .field-err.show{ display:block; }
  .cuenta-destino-list{ display:flex; flex-direction:column; gap:10px; width:100%; }
  .cuenta-destino-item{
    padding:14px 16px; border-radius:14px; cursor:pointer;
    border:2px solid var(--border); background:#fff; display:flex; flex-direction:column; gap:2px;
    -webkit-tap-highlight-color:transparent; transition:border-color .12s, background .12s;
  }
  .cuenta-destino-item:active{ background:#f7f7f7; }
  .cuenta-destino-item.activa{ border-color:var(--primary); background:rgba(255,122,24,.04); cursor:default; }
  .cuenta-destino-nombre{ font-size:15px; font-weight:800; color:var(--text); }
  .cuenta-destino-id{ font-size:12px; font-weight:600; color:var(--muted); }
  .cuenta-destino-badge{ font-size:11px; font-weight:700; color:var(--primary); margin-top:3px; }
  .divider{ border:none; border-top:1px dashed rgba(0,0,0,.10); width:100%; }
  .link-back{
    font-size:13px; font-weight:700; color:var(--muted); cursor:pointer;
    text-align:center; display:block; background:none; border:none; font-family:inherit;
  }
  .link-back:active{ color:var(--primary); }
  .cta{
    width:100%; padding:13px; font-size:15px; font-weight:800; font-family:inherit;
    border:0; border-radius:12px; cursor:pointer; color:#fff; background:var(--primary);
    box-shadow:0 6px 12px rgba(255,122,24,.22); -webkit-tap-highlight-color:transparent;
    transition:transform .06s ease, filter .06s ease;
  }
  .cta:active{ transform:translateY(1px); filter:brightness(.98); }
  .err-inline{
    font-weight:800; padding:10px 12px; border-radius:12px; font-size:13px;
    color:#b00; background:rgba(190,0,0,.08); border:1px solid rgba(190,0,0,.14);
  }

  /* Pantalla espera */
  .ok-card{
    width:100%; max-width:360px; background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); padding:24px 20px 28px; box-shadow:var(--shadow);
    position:relative; overflow:hidden; display:flex; flex-direction:column; gap:14px;
  }
  .ok-card::before{
    content:""; position:absolute; top:0; left:0; right:0; height:8px;
    background:linear-gradient(90deg,rgba(0,200,120,.8),rgba(0,170,100,.9));
  }
  .ok-pill{
    display:inline-flex; align-items:center; gap:6px; padding:6px 14px; border-radius:999px;
    font-size:13px; font-weight:700; color:#0a7;
    background:rgba(0,170,120,.10); border:1px solid rgba(0,170,120,.18);
  }
  .ok-nombre{ font-size:18px; font-weight:800; margin-top:2px; }
  .wait-box{
    display:flex; flex-direction:column; align-items:center; gap:12px;
    background:#f7f7f7; border-radius:14px; padding:20px 16px; text-align:center;
  }
  .spinner{
    width:36px; height:36px; border-radius:50%;
    border:4px solid rgba(255,122,24,.15); border-top-color:var(--primary);
    animation:spin 0.9s linear infinite;
  }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  .wait-text{ font-size:14px; font-weight:700; color:var(--text); line-height:1.4; }
  .wait-sub{ font-size:12px; color:var(--muted); }
  .err-box{
    font-size:13px; color:#b00; font-weight:600; text-align:center;
    background:rgba(190,0,0,.08); border:1px solid rgba(190,0,0,.14); border-radius:12px; padding:12px;
  }
  .cta-ir{
    padding:13px; width:100%; font-size:15px; font-weight:800; font-family:inherit;
    border:0; border-radius:12px; cursor:pointer; color:#fff; background:var(--primary);
    box-shadow:0 6px 12px rgba(255,122,24,.22); -webkit-tap-highlight-color:transparent;
    transition:transform .06s ease; display:block; text-align:center;
  }
  .cta-ir:active{ transform:translateY(1px); }
  .cta-ir.secondary{ background:#f0f0f0; color:var(--text); box-shadow:none; margin-top:10px; }

  /* Modal */
  .modal-overlay{
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);
    z-index:1000; align-items:flex-end; justify-content:center;
  }
  .modal-overlay.open{ display:flex; }
  .modal-box{
    background:#fff; border-radius:24px 24px 0 0; padding:28px 20px 40px;
    width:100%; max-width:480px; max-height:90vh; overflow-y:auto;
    box-shadow:0 -8px 32px rgba(0,0,0,.15); animation:slideUp .25s ease; position:relative;
  }
  @keyframes slideUp{ from{ transform:translateY(100%); } to{ transform:translateY(0); } }
  .modal-handle{ width:40px; height:4px; border-radius:999px; background:#ddd; margin:0 auto 20px; display:block; }
  .modal-title{ font-size:20px; font-weight:800; margin-bottom:4px; }
  .modal-sub{ font-size:13px; color:var(--muted); margin-bottom:16px; line-height:1.4; }
  .modal-close{
    position:absolute; top:16px; right:20px; font-size:22px; cursor:pointer;
    color:var(--muted); background:none; border:none; font-family:inherit;
  }
  label{ font-weight:700; font-size:13px; color:var(--muted); margin-top:14px; display:block; margin-bottom:5px; }
  input, select, textarea{
    width:100%; padding:11px 12px; font-size:14px; font-family:inherit;
    border:1.5px solid rgba(0,0,0,.12); border-radius:12px; background:#fff; color:var(--text);
    outline:none; transition:border-color .15s, box-shadow .15s; -webkit-appearance:none; appearance:none;
  }
  input:focus, select:focus, textarea:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(255,122,24,.12); }
  input.invalid{ border-color:#e00; background:#fff8f8; }
  input.valid{ border-color:#0a7; background:#f5fbf8; }
  textarea{ resize:vertical; min-height:100px; }
  .char-count{ font-size:11px; color:var(--muted); text-align:right; margin-top:3px; }
</style>
</head>
<body>

<!-- ══ Vista QR principal ══ -->
<div id="main" style="display:none; flex-direction:column; align-items:center; width:100%; max-width:360px; gap:16px;">
  <div class="brand"><img src="./TuQRLogo.png" alt="TuQR"/></div>
  <div class="card">
    <div class="qr-box"><canvas id="qrCanvas"></canvas></div>

    <!-- Recuadro datos mini copiable -->
    <div class="datos-mini" id="datosMini" onclick="copiarDatosMini()">
      <pre id="datosPreEl"></pre>
      <div class="datos-mini-footer">
        <span class="datos-mini-hint">Toca para copiar datos de transferencia</span>
        <span class="datos-mini-label" id="datosMiniLabel">Copiar</span>
        <span class="datos-mini-ok"   id="datosMiniOk">✓ Copiado</span>
      </div>
    </div>

    <button class="btn-gestion" id="btnGestion">⇄ Cambiar o crear cuenta destino</button>
    <button class="link-contacto" id="btnContactoApp">Contacto</button>
    <button class="link-cerrar-sesion" id="btnCerrarSesion">cerrar sesión</button>
  </div>
</div>

<!-- ══ Gestión: listado + nueva cuenta ══ -->
<div id="screenGestion">
  <div class="brand"><img src="./TuQRLogo.png" alt="TuQR"/></div>
  <div class="card">
    <div class="react-title">Cuentas destino</div>
    <div class="react-sub">Selecciona una existente o crea una nueva.</div>

    <!-- Datos identidad: Nombre + RUT -->
    <div class="identity-box">
      <div class="identity-label">Usuario</div>
      <div class="identity-value" id="identityNombre">—</div>
      <div class="identity-sub"  id="identityRut">—</div>
    </div>

    <div class="cuenta-destino-list" id="listaCuentasDestino"></div>

    <hr class="divider"/>
    <div class="section-title">Nueva cuenta destino</div>

    <div style="width:100%">
      <label class="r-label">Nombre de cuenta destino</label>
      <input class="r-input" id="newId" placeholder="ej: JuanBCI"
             autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <div class="field-err" id="err-newId">No puede contener espacios</div>
    </div>
    <div class="r-row">
      <div>
        <label class="r-label">Tipo de cuenta</label>
        <select class="r-select" id="newTipo">
          <option value="">— Selecciona —</option>
          <option value="Cuenta Corriente">Corriente</option>
          <option value="Cuenta Vista">Vista</option>
          <option value="Cuenta RUT">Cuenta RUT</option>
        </select>
      </div>
      <div>
        <label class="r-label">N° de cuenta</label>
        <input class="r-input" id="newNumero" placeholder="Solo números" inputmode="numeric"/>
        <div class="field-err" id="err-newNumero">Solo números</div>
      </div>
    </div>
    <div style="width:100%">
      <label class="r-label">Banco</label>
      <select class="r-select" id="newBanco">
        <option value="">— Selecciona —</option>
        <option>Banco de Chile</option><option>Banco BICE</option><option>Banco Consorcio</option>
        <option>Banco BCI</option><option>Banco Estado</option><option>Banco Falabella</option>
        <option>Banco Internacional</option><option>Banco Itaú</option><option>Banco Ripley</option>
        <option>Banco Santander</option><option>Banco Security</option><option>Scotiabank</option>
        <option>Tapp Caja Los Andes</option><option>Banco Tenpo</option><option>Mercado Pago</option>
      </select>
    </div>
    <div id="msg-nueva-err"></div>
    <button class="cta" id="btnGuardarNueva">Guardar nueva cuenta destino</button>
    <button class="link-back" id="backFromGestion">← Volver al QR</button>
  </div>
</div>

<!-- ══ Espera activación nueva cuenta ══ -->
<div id="screenEspera">
  <div class="brand"><img src="./TuQRLogo.png" alt="TuQR"/></div>
  <div class="ok-card">
    <div>
      <div class="ok-pill">✓ Cuenta destino creada</div>
      <div class="ok-nombre" id="esperaNombre"></div>
    </div>
    <div class="wait-box" id="esperaWaitBox">
      <div class="spinner"></div>
      <div class="wait-text">Activando tu cuenta destino…</div>
      <div class="wait-sub">Puede tardar hasta un minuto</div>
    </div>
    <div id="esperaError" style="display:none; flex-direction:column; gap:10px;">
      <div class="err-box">No pudimos confirmar la activación. Intenta abriendo tu QR manualmente.</div>
      <button class="cta-ir" id="btnEsperaIrApp">Ver mi QR →</button>
      <button class="cta-ir secondary" id="btnEsperaReintentar">↺ Reintentar</button>
    </div>
  </div>
</div>

<!-- ══ Reactivar sesión ══ -->
<div id="screenReactivar">
  <div class="brand"><img src="./TuQRLogo.png" alt="TuQR"/></div>
  <div class="card">
    <div class="react-title">Activa TuQR</div>
    <div class="react-sub">Ingresa tu RUT y teléfono para acceder a tu cuenta destino.</div>
    <div style="width:100%">
      <label class="r-label">RUT</label>
      <input class="r-input" id="reactRut" placeholder="12.345.678-9" maxlength="12"/>
      <div class="field-err" id="err-reactRut">RUT inválido</div>
    </div>
    <div style="width:100%">
      <label class="r-label">Teléfono</label>
      <div class="phone-wrap">
        <input class="phone-prefix" value="+56" readonly/>
        <input class="r-input" id="reactTel" placeholder="912345678" inputmode="numeric" maxlength="9"/>
      </div>
      <div class="field-err" id="err-reactTel">Número inválido</div>
    </div>
    <div class="field-err" id="err-reactGeneral">No encontramos un usuario con esos datos.</div>
    <button class="cta" id="btnReactivar">Activar</button>
    <a style="font-size:13px;font-weight:700;color:var(--muted);text-align:center;margin-top:8px;cursor:pointer;display:block;"
       onclick="window.location.replace('./admin.html?from=welcome')">← Crear nuevo usuario</a>
    <button class="link-contacto" id="btnContactoReact" style="margin-top:6px">Contacto</button>
  </div>
</div>

<!-- ══ Elegir cuenta destino al reactivar (múltiples) ══ -->
<div id="screenElegirReact">
  <div class="brand"><img src="./TuQRLogo.png" alt="TuQR"/></div>
  <div class="card">
    <div class="react-title">Elige tu cuenta destino</div>
    <div class="react-sub">Encontramos más de una. ¿Cuál quieres activar?</div>
    <div class="cuenta-destino-list" id="listaCuentasReact"></div>
    <button class="link-back" id="backFromElegirReact">← Volver</button>
  </div>
</div>

<!-- ══ Modal Contacto ══ -->
<div class="modal-overlay" id="modalContacto">
  <div class="modal-box">
    <button class="modal-close" id="btnCerrarModal">✕</button>
    <span class="modal-handle"></span>
    <div class="modal-title">Contacto</div>
    <div class="modal-sub">Te responderemos al correo de tu usuario.</div>
    <label for="cRut">RUT</label>
    <input id="cRut" placeholder="12.345.678-9" maxlength="12"/>
    <div class="field-err" id="err-cRut">RUT inválido</div>
    <label for="cCuentaDestino">Cuenta Destino</label>
    <select id="cCuentaDestino"><option value="">— Selecciona —</option></select>
    <div class="field-err" id="err-cCuentaDestino">Selecciona una cuenta destino</div>
    <label for="cTipo">Tipo de problema</label>
    <select id="cTipo">
      <option value="">— Selecciona —</option>
      <option value="cuenta_destino">Cuenta Destino</option>
      <option value="modificar_datos">Modificar datos</option>
      <option value="otros">Otros</option>
    </select>
    <div class="field-err" id="err-cTipo">Selecciona un tipo</div>
    <label for="cMensaje">Describe tu problema</label>
    <textarea id="cMensaje" maxlength="500" placeholder="Escribe aquí..."></textarea>
    <div class="char-count"><span id="charCount">0</span>/500</div>
    <div class="field-err" id="err-cMensaje">Escribe al menos 10 caracteres</div>
    <button class="cta" id="btnEnviarContacto" style="margin-top:20px">Enviar</button>
    <div id="msg-contacto-err"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  emailjs.init('yejdBOXVs6y3d8piR');

  const WORKER_URL  = 'https://tuqr-worker.nestragues.workers.dev/';
  const BASE_URL    = 'https://tuqrapp.github.io/tuqr.github.io/';
  const DATA_URL    = BASE_URL + 'data.json';
  const STORAGE_KEY = 'tuqr_id';

  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

  function clean(s){
    return String(s??'').normalize('NFC')
      .replace(/\u00A0/g,' ').replace(/[\u200B-\u200F\uFEFF]/g,'').trim();
  }
  function validarRut(rut){
    const r=rut.replace(/[\.\-\s]/g,'').toUpperCase();
    if(!/^\d{7,8}[0-9K]$/.test(r)) return false;
    const cuerpo=r.slice(0,-1), dv=r.slice(-1);
    let suma=0, mul=2;
    for(let i=cuerpo.length-1;i>=0;i--){ suma+=parseInt(cuerpo[i])*mul; mul=mul===7?2:mul+1; }
    const dvE=11-(suma%11);
    return dv===(dvE===11?'0':dvE===10?'K':String(dvE));
  }
  function formatearRut(rut){
    const r=rut.replace(/[\.\-\s]/g,'');
    if(r.length<2) return r;
    return r.slice(0,-1).replace(/\B(?=(\d{3})+(?!\d))/g,'.')+'-'+r.slice(-1);
  }
  function normalizarRut(rut){ return rut.replace(/[\.\-\s]/g,'').toUpperCase(); }
  function validarTel(t){ return /^9\d{8}$/.test(t.replace(/\s/g,'')); }
  function validarId(s){ return s.length>0 && !/\s/.test(s); }

  function generarQR(url){
    const canvas=document.getElementById('qrCanvas');
    const size=Math.min(300,window.innerWidth-100);
    canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
    const tmp=document.createElement('div');
    new QRCode(tmp,{text:url,width:size,height:size,correctLevel:QRCode.CorrectLevel.M});
    setTimeout(()=>{
      const src=tmp.querySelector('canvas');
      if(src){ canvas.width=src.width; canvas.height=src.height; canvas.getContext('2d').drawImage(src,0,0); }
    },100);
  }

  /* ── Clipboard ── */
  function copyText(text){
    const payload=text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    if(navigator.clipboard && typeof navigator.clipboard.writeText==='function'){
      return navigator.clipboard.writeText(payload).then(()=>true).catch(()=>{
        if(window.ClipboardItem){
          return navigator.clipboard.write([
            new ClipboardItem({'text/plain':Promise.resolve(new Blob([payload],{type:'text/plain'}))})
          ]).then(()=>true).catch(()=>legacyCopy(payload));
        }
        return legacyCopy(payload);
      });
    }
    return Promise.resolve(legacyCopy(payload));
  }
  function legacyCopy(text){
    try{
      const ta=document.createElement('textarea');
      ta.value=text; ta.setAttribute('readonly','');
      ta.style.cssText='position:fixed;top:0;left:0;width:2em;height:2em;padding:0;border:none;outline:none;background:transparent;opacity:0;pointer-events:none;z-index:-1';
      document.body.appendChild(ta); ta.focus({preventScroll:true}); ta.select(); ta.setSelectionRange(0,ta.value.length);
      const ok=document.execCommand('copy'); document.body.removeChild(ta); return ok;
    }catch(_){ return false; }
  }

  function formatRutDisplay(raw){
    const r=raw.replace(/[\.\-\s]/g,'');
    if(r.length<2) return r;
    return r.slice(0,-1).replace(/\B(?=(\d{3})+(?!\d))/g,'.')+'-'+r.slice(-1);
  }

  function buildDatosText(d){
    const lines=[
      `Nombre: ${clean(d.nombre)}`,
      `RUT: ${formatRutDisplay(clean(d.rut))}`,
      `Banco: ${clean(d.banco)}`,
      `Tipo de cuenta: ${clean(d.tipoCuenta)}`,
      `N° de cuenta: ${clean(d.numeroCuenta)}`
    ];
    if(d.correo) lines.push(`Correo: ${clean(d.correo)}`);
    return lines.join('\n');
  }

  let allData={};
  let usuarioActivo=null;
  let cachedDatosText='';
  let miniOkTimer=null;

  function copiarDatosMini(){
    if(!cachedDatosText) return;
    copyText(cachedDatosText).then(ok=>{
      if(ok){
        const label=document.getElementById('datosMiniLabel');
        const okEl=document.getElementById('datosMiniOk');
        label.style.display='none'; okEl.style.display='block';
        if(miniOkTimer) clearTimeout(miniOkTimer);
        miniOkTimer=setTimeout(()=>{ label.style.display=''; okEl.style.display='none'; },1800);
      }
    });
  }

  async function cargarData(){
    try{
      const res=await fetch(DATA_URL+'?ts='+Date.now(),{cache:'no-store'});
      allData=await res.json();
    }catch(e){ allData={}; }
    return allData;
  }

  async function mostrarApp(id){
    try{
      await cargarData();
      const d=allData[id];
      if(!d) return false;
      usuarioActivo={
        rut:          normalizarRut(d.rut||''),
        tel:          (d.telefono||'').replace(/\D/g,''),
        nombre:       clean(d.nombre),
        rut_display:  formatRutDisplay(clean(d.rut)),
        telefono_raw: (d.telefono||'').replace(/\D/g,'')
      };
      const qrUrl=BASE_URL+'?id='+encodeURIComponent(id);
      document.title='TuQR — '+clean(d.nombre);
      generarQR(qrUrl);

      // Datos mini
      cachedDatosText=buildDatosText(d);
      document.getElementById('datosPreEl').textContent=cachedDatosText;
      document.getElementById('datosMiniLabel').style.display='';
      document.getElementById('datosMiniOk').style.display='none';

      document.getElementById('main').style.display='flex';
      document.getElementById('screenGestion').style.display='none';
      document.getElementById('screenReactivar').style.display='none';
      document.getElementById('screenElegirReact').style.display='none';
      document.getElementById('screenEspera').style.display='none';
      return true;
    }catch(e){ return false; }
  }

  /* ── Cerrar sesión ── */
  document.getElementById('btnCerrarSesion').addEventListener('click',()=>{
    localStorage.removeItem(STORAGE_KEY);
    usuarioActivo=null;
    cachedDatosText='';
    document.getElementById('main').style.display='none';
    // Limpiar campos reactivar
    document.getElementById('reactRut').value='';
    document.getElementById('reactTel').value='';
    ['err-reactRut','err-reactTel','err-reactGeneral'].forEach(i=>{
      const el=document.getElementById(i);
      if(el) el.classList.remove('show');
    });
    ['reactRut','reactTel'].forEach(i=>{
      const el=document.getElementById(i);
      if(el) el.classList.remove('valid','invalid');
    });
    document.getElementById('screenReactivar').style.display='flex';
  });

  /* ── Gestión ── */
  async function mostrarGestion(){
    await cargarData();
    const savedId=localStorage.getItem(STORAGE_KEY);
    if(usuarioActivo){
      // Mostrar Nombre + RUT en el recuadro de identidad
      document.getElementById('identityNombre').textContent=usuarioActivo.nombre;
      document.getElementById('identityRut').textContent=usuarioActivo.rut_display;
    }
    const lista=document.getElementById('listaCuentasDestino');
    lista.innerHTML='';
    if(usuarioActivo){
      Object.entries(allData)
        .filter(([id,d])=>normalizarRut(d.rut||'')===usuarioActivo.rut&&(d.telefono||'').replace(/\D/g,'')===usuarioActivo.tel)
        .forEach(([id,d])=>{
          const item=document.createElement('div');
          const esActiva=id===savedId;
          item.className='cuenta-destino-item'+(esActiva?' activa':'');
          item.innerHTML=`
            <div class="cuenta-destino-nombre">${clean(d.nombre)}</div>
            <div class="cuenta-destino-id">${clean(d.banco)} · ${clean(d.tipoCuenta)}</div>
            ${esActiva?'<div class="cuenta-destino-badge">✓ Activa ahora</div>':''}
          `;
          if(!esActiva){
            item.addEventListener('click',()=>{ localStorage.setItem(STORAGE_KEY,id); mostrarApp(id); });
          }
          lista.appendChild(item);
        });
    }
    ['newId','newNumero'].forEach(i=>{ const e=document.getElementById(i); if(e){e.value='';e.classList.remove('valid','invalid');} });
    document.getElementById('newTipo').value='';
    document.getElementById('newBanco').value='';
    document.getElementById('msg-nueva-err').innerHTML='';
    ['err-newId','err-newNumero'].forEach(i=>document.getElementById(i).classList.remove('show'));
    document.getElementById('main').style.display='none';
    document.getElementById('screenGestion').style.display='flex';
  }

  document.getElementById('btnGestion').addEventListener('click',mostrarGestion);
  document.getElementById('backFromGestion').addEventListener('click',()=>{
    document.getElementById('screenGestion').style.display='none';
    document.getElementById('main').style.display='flex';
  });

  /* ── Guardar nueva cuenta destino → pantalla espera ── */
  const newIdInput=document.getElementById('newId');
  const newNumeroInput=document.getElementById('newNumero');

  newIdInput.addEventListener('input',function(){
    const ok=validarId(this.value);
    this.classList.toggle('valid',this.value.length>0&&ok);
    this.classList.toggle('invalid',this.value.length>0&&!ok);
    document.getElementById('err-newId').classList.toggle('show',this.value.length>0&&!ok);
  });
  newNumeroInput.addEventListener('input',function(){
    this.value=this.value.replace(/\D/g,'');
    this.classList.toggle('valid',this.value.length>0);
  });

  let pollTimer=null, pollCount=0;
  function iniciarPolling(id){
    pollCount=0; clearInterval(pollTimer); checkIdPoll(id);
    pollTimer=setInterval(()=>checkIdPoll(id), 5000);
  }
  async function checkIdPoll(id){
    pollCount++;
    try{
      const res=await fetch(DATA_URL+'?ts='+Date.now(),{cache:'no-store'});
      if(!res.ok) throw new Error();
      const all=await res.json();
      if(all[id]){
        clearInterval(pollTimer);
        allData=all;
        await mostrarApp(id);
        return;
      }
    }catch(e){}
    if(pollCount>=24){
      clearInterval(pollTimer);
      document.getElementById('esperaWaitBox').style.display='none';
      document.getElementById('esperaError').style.display='flex';
    }
  }

  document.getElementById('btnGuardarNueva').addEventListener('click',async function(){
    const msgErr=document.getElementById('msg-nueva-err');
    msgErr.innerHTML='';
    const idVal    =newIdInput.value.trim();
    const tipoVal  =document.getElementById('newTipo').value;
    const numeroVal=newNumeroInput.value.trim();
    const bancoVal =document.getElementById('newBanco').value;
    if(!idVal||!tipoVal||!numeroVal||!bancoVal){
      msgErr.innerHTML='<div class="err-inline">Completa todos los campos.</div>'; return;
    }
    if(!validarId(idVal)){
      msgErr.innerHTML='<div class="err-inline">El nombre no puede tener espacios.</div>';
      newIdInput.focus(); return;
    }
    if(!/^\d+$/.test(numeroVal)){
      msgErr.innerHTML='<div class="err-inline">El número de cuenta debe ser solo dígitos.</div>';
      newNumeroInput.focus(); return;
    }
    if(!usuarioActivo){
      msgErr.innerHTML='<div class="err-inline">Sesión expirada. Recarga la página.</div>'; return;
    }
    await cargarData();
    if(allData[idVal]){
      msgErr.innerHTML='<div class="err-inline">El nombre <strong>'+idVal+'</strong> ya existe. Elige otro.</div>';
      newIdInput.focus(); return;
    }
    this.textContent='Guardando…'; this.disabled=true;
    const savedId=localStorage.getItem(STORAGE_KEY);
    const datosUsuario=allData[savedId]||{};
    const payload={
      id:idVal,
      nombre:       clean(datosUsuario.nombre||''),
      rut:          clean(datosUsuario.rut||''),
      banco:        bancoVal,
      tipoCuenta:   tipoVal,
      numeroCuenta: numeroVal,
      correo:       clean(datosUsuario.correo||''),
      telefono:     usuarioActivo.telefono_raw
    };
    try{
      const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const txt=await res.text();
      let data={};
      try{ data=JSON.parse(txt); }catch{}
      if(!res.ok||!data.ok){
        const detail=data.error?' — '+data.error:' HTTP '+res.status;
        msgErr.innerHTML='<div class="err-inline">Error al guardar.'+detail+'</div>';
        this.textContent='Guardar nueva cuenta destino'; this.disabled=false; return;
      }
      // Éxito → ir a pantalla de espera
      localStorage.setItem(STORAGE_KEY,idVal);
      document.getElementById('esperaNombre').textContent=clean(datosUsuario.nombre||idVal);
      document.getElementById('esperaWaitBox').style.display='flex';
      document.getElementById('esperaError').style.display='none';
      document.getElementById('screenGestion').style.display='none';
      document.getElementById('screenEspera').style.display='flex';
      window.scrollTo({top:0,behavior:'smooth'});
      iniciarPolling(idVal);
      this.textContent='Guardar nueva cuenta destino'; this.disabled=false;
    }catch(e){
      msgErr.innerHTML='<div class="err-inline">Error de red: '+e+'</div>';
      this.textContent='Guardar nueva cuenta destino'; this.disabled=false;
    }
  });

  document.getElementById('btnEsperaIrApp').addEventListener('click',()=>{
    const id=localStorage.getItem(STORAGE_KEY);
    if(id) mostrarApp(id);
  });
  document.getElementById('btnEsperaReintentar').addEventListener('click',()=>{
    document.getElementById('esperaWaitBox').style.display='flex';
    document.getElementById('esperaError').style.display='none';
    const id=localStorage.getItem(STORAGE_KEY);
    if(id) iniciarPolling(id);
  });

  /* ── Init ── */
  async function init(){
    const savedId=localStorage.getItem(STORAGE_KEY);
    if(savedId){
      const ok=await mostrarApp(savedId);
      if(ok) return;
      localStorage.removeItem(STORAGE_KEY);
    }
    document.getElementById('screenReactivar').style.display='flex';
  }

  /* ── Reactivar ── */
  const reactRutInput=document.getElementById('reactRut');
  const reactTelInput=document.getElementById('reactTel');

  reactRutInput.addEventListener('input',function(){
    const raw=this.value.replace(/[\.\-\s]/g,'');
    if(raw.length>=2) this.value=formatearRut(raw);
    const ok=validarRut(this.value);
    this.classList.toggle('valid',this.value.length>0&&ok);
    this.classList.toggle('invalid',this.value.length>0&&!ok);
    document.getElementById('err-reactRut').classList.toggle('show',this.value.length>0&&!ok);
    document.getElementById('err-reactGeneral').classList.remove('show');
  });
  reactTelInput.addEventListener('input',function(){
    this.value=this.value.replace(/\D/g,'');
    const ok=validarTel(this.value);
    this.classList.toggle('valid',this.value.length>0&&ok);
    this.classList.toggle('invalid',this.value.length>0&&!ok);
    document.getElementById('err-reactTel').classList.toggle('show',this.value.length>0&&!ok);
  });

  document.getElementById('backFromElegirReact').addEventListener('click',()=>{
    document.getElementById('screenElegirReact').style.display='none';
    document.getElementById('screenReactivar').style.display='flex';
  });

  document.getElementById('btnReactivar').addEventListener('click',async function(){
    const rutVal=reactRutInput.value.trim();
    const telVal=reactTelInput.value.replace(/\D/g,'');
    const errGen=document.getElementById('err-reactGeneral');
    errGen.classList.remove('show');
    if(!validarRut(rutVal)){reactRutInput.classList.add('invalid');document.getElementById('err-reactRut').classList.add('show');return;}
    if(!validarTel(telVal)){reactTelInput.classList.add('invalid');document.getElementById('err-reactTel').classList.add('show');return;}
    this.textContent='Verificando…'; this.disabled=true;
    try{
      await cargarData();
      const rutNorm=normalizarRut(rutVal);
      const matches=Object.entries(allData).filter(([id,d])=>
        normalizarRut(d.rut||'')===rutNorm&&(d.telefono||'').replace(/\D/g,'')===telVal
      );
      if(matches.length===0){
        errGen.classList.add('show'); this.textContent='Activar'; this.disabled=false;
      } else if(matches.length===1){
        localStorage.setItem(STORAGE_KEY,matches[0][0]);
        await mostrarApp(matches[0][0]);
        this.textContent='Activar'; this.disabled=false;
      } else {
        const list=document.getElementById('listaCuentasReact');
        list.innerHTML='';
        matches.forEach(([id,d])=>{
          const item=document.createElement('div');
          item.className='cuenta-destino-item';
          item.innerHTML=`<div class="cuenta-destino-nombre">${clean(d.nombre)}</div><div class="cuenta-destino-id">${clean(d.banco)} · ${clean(d.tipoCuenta)}</div>`;
          item.addEventListener('click',async()=>{
            localStorage.setItem(STORAGE_KEY,id);
            await mostrarApp(id);
            document.getElementById('screenElegirReact').style.display='none';
          });
          list.appendChild(item);
        });
        document.getElementById('screenReactivar').style.display='none';
        document.getElementById('screenElegirReact').style.display='flex';
        this.textContent='Activar'; this.disabled=false;
      }
    }catch(e){
      errGen.textContent='Error al conectar. Intenta de nuevo.';
      errGen.classList.add('show'); this.textContent='Activar'; this.disabled=false;
    }
  });

  /* ── Modal Contacto ── */
  async function abrirModalContacto(){
    document.getElementById('modalContacto').classList.add('open');
    document.getElementById('cMensaje').value='';
    document.getElementById('charCount').textContent='0';
    document.getElementById('msg-contacto-err').innerHTML='';
    document.getElementById('cTipo').value='';
    document.getElementById('btnEnviarContacto').textContent='Enviar';
    document.getElementById('btnEnviarContacto').disabled=false;
    ['err-cRut','err-cCuentaDestino','err-cTipo','err-cMensaje'].forEach(i=>{document.getElementById(i).classList.remove('show');});
    const savedId=localStorage.getItem(STORAGE_KEY);
    await cargarData();
    const cRutEl=document.getElementById('cRut');
    const cCEl=document.getElementById('cCuentaDestino');
    cCEl.innerHTML='<option value="">— Selecciona —</option>';
    cRutEl.value=''; cRutEl.classList.remove('valid','invalid');
    if(savedId&&allData[savedId]){
      const d=allData[savedId];
      cRutEl.value=d.rut||''; cRutEl.classList.add('valid');
      const rutNorm=normalizarRut(d.rut||'');
      Object.entries(allData).forEach(([id,u])=>{
        if(normalizarRut(u.rut||'')===rutNorm){
          const opt=document.createElement('option');
          opt.value=id; opt.textContent=`${clean(u.nombre)} — ${clean(u.banco)}`;
          if(id===savedId) opt.selected=true;
          cCEl.appendChild(opt);
        }
      });
    }
  }

  function cerrarModal(){ document.getElementById('modalContacto').classList.remove('open'); }
  document.getElementById('btnCerrarModal').addEventListener('click',cerrarModal);
  document.getElementById('modalContacto').addEventListener('click',function(e){ if(e.target===this) cerrarModal(); });

  ['btnContactoApp','btnContactoReact'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('click',abrirModalContacto);
  });

  document.getElementById('cRut').addEventListener('input',async function(){
    const raw=this.value.replace(/[\.\-\s]/g,'');
    if(raw.length>=2) this.value=formatearRut(raw);
    const ok=validarRut(this.value);
    this.classList.toggle('valid',this.value.length>0&&ok);
    this.classList.toggle('invalid',this.value.length>0&&!ok);
    document.getElementById('err-cRut').classList.toggle('show',this.value.length>0&&!ok);
    const sel=document.getElementById('cCuentaDestino');
    sel.innerHTML='<option value="">— Selecciona —</option>';
    if(ok){
      await cargarData();
      const rutNorm=normalizarRut(this.value);
      Object.entries(allData).forEach(([id,d])=>{
        if(normalizarRut(d.rut||'')===rutNorm){
          const opt=document.createElement('option');
          opt.value=id; opt.textContent=`${clean(d.nombre)} — ${clean(d.banco)}`;
          sel.appendChild(opt);
        }
      });
    }
  });

  document.getElementById('cMensaje').addEventListener('input',function(){ document.getElementById('charCount').textContent=this.value.length; });

  document.getElementById('btnEnviarContacto').addEventListener('click',async function(){
    const msgErr=document.getElementById('msg-contacto-err');
    msgErr.innerHTML='';
    let ok=true;
    const rut=document.getElementById('cRut').value.trim();
    const cuentaDestino=document.getElementById('cCuentaDestino').value;
    const tipo=document.getElementById('cTipo').value;
    const mensaje=document.getElementById('cMensaje').value.trim();
    if(!validarRut(rut)){document.getElementById('err-cRut').classList.add('show');ok=false;}
    if(!cuentaDestino){document.getElementById('err-cCuentaDestino').classList.add('show');ok=false;}
    if(!tipo){document.getElementById('err-cTipo').classList.add('show');ok=false;}
    if(mensaje.length<10){document.getElementById('err-cMensaje').classList.add('show');ok=false;}
    if(!ok) return;
    this.textContent='Enviando…'; this.disabled=true;
    const userData=allData[cuentaDestino]||{};
    const replyTo=userData.correo||'sin-correo@tuqr.app';
    const nombreUsuario=clean(userData.nombre||cuentaDestino);
    try{
      await emailjs.send('service_pbr7qdo','template_emm0576',{
        from_name:nombreUsuario, rut, usuario:cuentaDestino, tipo_problema:tipo, mensaje, reply_to:replyTo
      });
      msgErr.innerHTML='<div style="color:#0a7;font-weight:700;margin-top:10px;">✓ Mensaje enviado.</div>';
      this.textContent='Enviado ✓';
    }catch(e){
      msgErr.innerHTML='<div style="color:#b00;font-weight:800;margin-top:10px;">Error al enviar. Intenta de nuevo.</div>';
      this.textContent='Enviar'; this.disabled=false;
    }
  });

  init();
</script>
</body>
</html>
