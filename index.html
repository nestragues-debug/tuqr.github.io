<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TuQR â€” Datos para transferir</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D9TN01T1R0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-D9TN01T1R0');
  </script>

  <style>
    body {
      font-family: system-ui, -apple-system, Arial;
      margin: 0;
      padding: 24px;
      background: #ffffff;
    }
    .card {
      max-width: 520px;
      margin: 0 auto;
      border: 1px solid #eee;
      border-radius: 16px;
      padding: 18px;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 8px;
    }
    p {
      margin: 0 0 14px;
      color: #444;
    }
    pre {
      background: #f6f6f6;
      padding: 14px;
      border-radius: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 15px;
      -webkit-text-size-adjust: 100%;
    }
    button {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      border: 0;
      border-radius: 12px;
      cursor: pointer;
      background: #0078ff;
      color: white;
      font-weight: 600;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .ok { margin-top: 10px; color: #0a7; font-weight: 700; display:none; }
    .err { margin-top: 10px; color: #b00; font-weight: 700; display:none; }
    .small { margin-top: 12px; font-size: 12px; color: #777; }

    /* Botones por campo */
    .fields {
      margin-top: 12px;
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr;
    }
    @media (min-width:520px){
      .fields { grid-template-columns: 1fr 1fr; }
    }
    .field-btn {
      padding: 12px;
      font-size: 15px;
      font-weight: 700;
      background:#f3f6fa;
      color:#123;
      border:1px solid #e5e9f0;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1 id="title">Paga con transferencia</h1>
    <p>Copia y pega en tu aplicaciÃ³n bancaria.</p>

    <pre id="datos">Cargandoâ€¦</pre>

    <button id="copiar" disabled>Copiar datos 23:39</button>

    <div id="ok" class="ok">Copiado</div>
    <div id="err" class="err">No encontramos este comercio</div>

    <!-- Botones de copiado por campo -->
    <div id="fields" class="fields" style="display:none;">
      <button id="copyNombre" class="field-btn">Copia Nombre</button>
      <button id="copyRut" class="field-btn">Copia Rut</button>
      <button id="copyBanco" class="field-btn">Copia Banco</button>
      <button id="copyTipo" class="field-btn">Copia Tipo de cuenta</button>
      <button id="copyNumero" class="field-btn">Copia Nro de cuenta</button>
      <button id="copyCorreo" class="field-btn">Copia Correo</button>
    </div>

    <div class="small">
      En TuQR solo copias los datos. <b>La transferencia se hace desde tu banco.</b>
    </div>
  </div>

<script>
const params = new URLSearchParams(location.search);
const id = (params.get('id') || '').trim();

const datosEl = document.getElementById('datos');
const btn = document.getElementById('copiar');
const okEl = document.getElementById('ok');
const errEl = document.getElementById('err');
const title = document.getElementById('title');

const fieldsWrap = document.getElementById('fields');
const btnNombre = document.getElementById('copyNombre');
const btnRut = document.getElementById('copyRut');
const btnBanco = document.getElementById('copyBanco');
const btnTipo = document.getElementById('copyTipo');
const btnNumero = document.getElementById('copyNumero');
const btnCorreo = document.getElementById('copyCorreo');

// UA detections (se mantienen, aunque no se usan para "Notas")
const ua = navigator.userAgent || '';
const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
const isAndroid = /Android/.test(ua);
const isSamsung = /SamsungBrowser/i.test(ua);
const isInAppWebView = /(FBAN|FBAV|Instagram|Line|Twitter|WhatsApp|wv)/i.test(ua);

// Limpieza extra estricta
function clean(s) {
  return String(s ?? '')
    .normalize('NFC')
    .replace(/\u00A0/g, ' ')
    .replace(/[\u200B-\u200F]/g, '')
    .replace(/\r\n/g, '\n')
    .replace(/[ \t]+$/gm, '')
    .trim();
}

// Sanitizacion solicitada:
// - reemplazar Ã±/Ã‘ por n
// - quitar tildes y dieresis (diacriticos) de vocales (y en general)
function sanitizeValue(s) {
  let t = clean(s);
  // Ã±/Ã‘ -> n
  t = t.replace(/Ã±/g, 'n').replace(/Ã‘/g, 'n');
  // remover diacriticos
  t = t.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  return t;
}

// ðŸ”¹ BLOQUE COPIADO con DESCRIPTORES (Correo opcional)
function buildText(d) {
  const nombre = sanitizeValue(d.nombre);
  const rut = sanitizeValue(d.rut);
  const banco = sanitizeValue(d.banco);
  const tipo = sanitizeValue(d.tipoCuenta);
  const numero = sanitizeValue(d.numeroCuenta);
  const correoRaw = d.correo ? sanitizeValue(d.correo) : '';

  const lines = [
    `Nombre: ${nombre}`,
    `Rut: ${rut}`,
    `Banco: ${banco}`,
    `Tipo de cuenta: ${tipo}`,
    `Numero de cuenta: ${numero}`
  ];

  if (correoRaw) {
    lines.push(`Correo: ${correoRaw}`);
  }

  return { text: lines.join('\n'), fields: { nombre, rut, banco, tipo, numero, correo: correoRaw } };
}

// Copiado universal robusto
async function copyTextUniversal(text) {

  if (navigator.clipboard && window.isSecureContext) {
    await navigator.clipboard.writeText(text);
    return;
  }

  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.readOnly = true;
    ta.style.position = 'fixed';
    ta.style.opacity = '0';
    document.body.appendChild(ta);

    ta.select();
    ta.setSelectionRange(0, text.length);
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    if (ok) return;
  } catch(e) {}

  const el = document.createElement('div');
  el.textContent = text;
  el.contentEditable = true;
  el.style.position = 'fixed';
  el.style.opacity = '0';
  document.body.appendChild(el);

  const range = document.createRange();
  range.selectNodeContents(el);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
  const ok2 = document.execCommand('copy');

  document.body.removeChild(el);
  if (!ok2) throw new Error('copy_failed');
}

function showCopied() {
  okEl.style.display = 'block';
  setTimeout(() => okEl.style.display = 'none', 1500);
}

let cachedText = '';
let cachedFields = null;

async function init() {
  try {
    const res = await fetch('./data.json', { cache: 'no-store' });
    const all = await res.json();
    const d = all[id];

    if (!id || !d) {
      datosEl.textContent = 'CÃ³digo invÃ¡lido';
      errEl.style.display = 'block';
      return;
    }

    // Titulo con nombre sanitizado
    title.textContent = `Paga a ${sanitizeValue(d.nombre)}`;

    // Texto visible y para copiar con descriptores
    const { text, fields } = buildText(d);
    cachedText = text;
    cachedFields = fields;

    datosEl.textContent = text;
    btn.disabled = false;

    // Eventos GA
    gtag('event', 'payer_page_view', { merchant_id: id });

    // BotÃ³n principal (copiar bloque completo)
    btn.addEventListener('click', async () => {
      try {
        await copyTextUniversal(cachedText);
        showCopied();
        gtag('event', 'copy_click', { merchant_id: id });
      } catch(e) {
        alert('No pudimos copiar automÃ¡ticamente. MantÃ©n presionado el texto y selecciona "Copiar".');
      }
    });

    // Mostrar y cablear los 6 botones de copiado por campo
    fieldsWrap.style.display = 'grid';

    btnNombre.addEventListener('click', async () => {
      try { await copyTextUniversal(cachedFields.nombre || ''); showCopied(); } catch(e) {}
    });
    btnRut.addEventListener('click', async () => {
      try { await copyTextUniversal(cachedFields.rut || ''); showCopied(); } catch(e) {}
    });
    btnBanco.addEventListener('click', async () => {
      try { await copyTextUniversal(cachedFields.banco || ''); showCopied(); } catch(e) {}
    });
    btnTipo.addEventListener('click', async () => {
      try { await copyTextUniversal(cachedFields.tipo || ''); showCopied(); } catch(e) {}
    });
    btnNumero.addEventListener('click', async () => {
      try { await copyTextUniversal(cachedFields.numero || ''); showCopied(); } catch(e) {}
    });
    btnCorreo.addEventListener('click', async () => {
      try { await copyTextUniversal(cachedFields.correo || ''); showCopied(); } catch(e) {}
    });

  } catch(e) {
    datosEl.textContent = 'Error cargando datos';
    errEl.style.display = 'block';
  }
}

init();
</script>

</body>
</html>
