<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TuQR ‚Äî Datos para transferir</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D9TN01T1R0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-D9TN01T1R0');
  </script>

  <style>
    body {
      font-family: system-ui, -apple-system, Arial;
      margin: 0;
      padding: 24px;
      background: #ffffff;
    }
    .card {
      max-width: 520px;
      margin: 0 auto;
      border: 1px solid #eee;
      border-radius: 16px;
      padding: 18px;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 8px;
    }
    p {
      margin: 0 0 14px;
      color: #444;
    }
    pre {
      background: #f6f6f6;
      padding: 14px;
      border-radius: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 15px;
      -webkit-text-size-adjust: 100%; /* Evita zoom autos */
    }
    button {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      border: 0;
      border-radius: 12px;
      cursor: pointer;
      background: #0078ff;
      color: white;
      font-weight: 600;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .ok { margin-top: 10px; color: #0a7; font-weight: 700; display:none; }
    .err { margin-top: 10px; color: #b00; font-weight: 700; display:none; }
    .small { margin-top: 12px; font-size: 12px; color: #777; }
    .tip { margin-top: 10px; font-size: 12px; color: #666; display:none; }
    .tip b { color:#333; }
  </style>
</head>

<body>
  <div class="card">
    <h1 id="title">Paga con transferencia</h1>
    <p>Copia y pega estos datos en tu aplicaci√≥n bancaria.</p>

    <pre id="datos">Cargando‚Ä¶</pre>

    <button id="copiar" disabled>üìã Copiar datos para transferir</button>

    <div id="ok" class="ok">Copiado ‚úÖ</div>
    <div id="err" class="err">No encontramos este cobrador</div>

    <div id="tip" class="tip">
      Si tu app no deja pegar el bloque completo, pega primero en <b>Notas</b> y vuelve a copiar desde ah√≠.
    </div>

    <div class="small">
      TuQR solo muestra datos. <b>La transferencia se hace en tu banco.</b>
    </div>
  </div>

<script>
const params = new URLSearchParams(location.search);
const id = (params.get('id') || '').trim();

const datosEl = document.getElementById('datos');
const btn = document.getElementById('copiar');
const okEl = document.getElementById('ok');
const errEl = document.getElementById('err');
const title = document.getElementById('title');
const tip = document.getElementById('tip');

// UA detections
const ua = navigator.userAgent || '';
const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
const isAndroid = /Android/.test(ua);
const isSamsung = /SamsungBrowser/i.test(ua);
const isInAppWebView = /(FBAN|FBAV|Instagram|Line|Twitter|WhatsApp|wv)/i.test(ua);

// Limpieza extra estricta
function clean(s) {
  return String(s ?? '')
    .normalize('NFC')
    .replace(/\u00A0/g, ' ')       // NBSP
    .replace(/[\u200B-\u200F]/g, '') // Zero-width chars
    .replace(/\r\n/g, '\n')        // CRLF -> LF
    .replace(/[ \t]+$/gm, '')      // trailing spaces
    .trim();
}

function buildText(d) {
  const lines = [
    `Nombre: ${clean(d.nombre)}`,
    `RUT: ${clean(d.rut)}`,
    `Banco: ${clean(d.banco)}`,
    `Tipo de cuenta: ${clean(d.tipoCuenta)}`,
    `N√∫mero de cuenta 1: ${clean(d.numeroCuenta)}`
  ];
  return lines.join('\n');
}

// Copiado universal robusto
async function copyTextUniversal(text) {

  // Clipboard API
  if (navigator.clipboard && window.isSecureContext) {
    await navigator.clipboard.writeText(text);
    return;
  }

  // Fallback: textarea
  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.readOnly = true;
    ta.style.position = 'fixed';
    ta.style.opacity = '0';
    document.body.appendChild(ta);

    ta.select();
    ta.setSelectionRange(0, text.length);
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);

    if (ok) return;
  } catch(e) {}

  // Fallback: contenteditable
  const el = document.createElement('div');
  el.textContent = text;
  el.contentEditable = true;
  el.style.position = 'fixed';
  el.style.opacity = '0';
  document.body.appendChild(el);

  const range = document.createRange();
  range.selectNodeContents(el);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
  const ok2 = document.execCommand('copy');

  document.body.removeChild(el);
  if (!ok2) throw new Error('copy_failed');
}

function showCopied() {
  okEl.style.display = 'block';
  setTimeout(() => okEl.style.display = 'none', 1500);
}

async function init() {
  try {
    const res = await fetch('./data.json', { cache: 'no-store' });
    const all = await res.json();
    const d = all[id];

    if (!id || !d) {
      datosEl.textContent = 'C√≥digo inv√°lido';
      errEl.style.display = 'block';
      return;
    }

    title.textContent = `Paga a ${clean(d.nombre)}`;
    const text = buildText(d);
    datosEl.textContent = text;
    btn.disabled = false;

    gtag('event', 'payer_page_view', { merchant_id: id });

    if (isIOS || isSamsung || isInAppWebView) tip.style.display = 'block';

    btn.addEventListener('click', async () => {
      try {
        await copyTextUniversal(text);
        showCopied();

        gtag('event', 'copy_click', { merchant_id: id });
      } catch(e) {
        alert('No pudimos copiar autom√°ticamente. Mant√©n presionado el texto y selecciona ‚ÄúCopiar‚Äù.');
      }
    });

  } catch(e) {
    datosEl.textContent = 'Error cargando datos';
    errEl.style.display = 'block';
  }
}

init();
</script>

</body>
</html>
