<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TuQR ‚Äî Datos para transferir</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D9TN01T1R0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-D9TN01T1R0');
  </script>

  <style>
    body{
      font-family: system-ui, -apple-system, Arial;
      margin:0; padding:24px; background:#fff;
    }
    .card{
      max-width:520px; margin:0 auto;
      border:1px solid #eee; border-radius:16px; padding:18px;
    }
    h1{ font-size:22px; margin:0 0 8px; }
    p{ margin:0 0 14px; color:#444; }
    pre{
      background:#f6f6f6; padding:14px; border-radius:12px;
      white-space:pre-wrap; word-break:break-word;
      font-size:15px; -webkit-text-size-adjust:100%;
      user-select:text; -webkit-user-select:text;
    }
    button{
      width:100%; padding:16px; font-size:18px;
      border:0; border-radius:12px; cursor:pointer;
      background:#0078ff; color:#fff; font-weight:600;
    }
    button:disabled{ background:#999; cursor:not-allowed; }
    .ok{ margin-top:10px; color:#0a7; font-weight:700; display:none; }
    .err{ margin-top:10px; color:#b00; font-weight:700; display:none; }
    .small{ margin-top:12px; font-size:12px; color:#777; }
    .tip{ margin-top:10px; font-size:12px; color:#666; display:none; }
    .tip b{ color:#333; }

    /* ‚úÖ Secci√≥n ‚Äúcopiar por campo‚Äù */
    .fields {
      margin-top: 14px;
      border-top: 1px solid #eee;
      padding-top: 14px;
    }
    .fields h2{
      font-size: 14px;
      margin: 0 0 10px;
      color:#333;
    }
    .field {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .chip{
      background:#f6f6f6;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      line-height: 1.2;
      word-break: break-word;
    }
    .btnSmall{
      width: auto;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 10px;
      background: #111;
      color: #fff;
      font-weight: 700;
      white-space: nowrap;
    }
    .hint {
      margin: 8px 0 0;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1 id="title">Paga con transferencia</h1>
    <p>Copia y pega estos datos en tu aplicaci√≥n bancaria.</p>

    <pre id="datos">Cargando‚Ä¶</pre>

    <button id="copiar" disabled>üìã Copiar datos para transferir</button>

    <div id="ok" class="ok">Copiado ‚úÖ</div>
    <div id="err" class="err">No encontramos este cobrador</div>

    <div id="tip" class="tip">
      Si tu app no deja pegar el bloque completo, pega primero en <b>Notas</b> y vuelve a copiar desde ah√≠.
    </div>

    <!-- ‚úÖ NUEVO: copiar por campo -->
    <div id="fields" class="fields" style="display:none;">
      <h2>¬øTu banco peg√≥ incompleto? Copia campo por campo:</h2>

      <div class="field">
        <div class="chip" id="f_nombre">Nombre: ‚Äî</div>
        <button class="btnSmall" id="b_nombre" type="button">Copiar</button>
      </div>

      <div class="field">
        <div class="chip" id="f_rut">Rut: ‚Äî</div>
        <button class="btnSmall" id="b_rut" type="button">Copiar</button>
      </div>

      <div class="field">
        <div class="chip" id="f_banco">Banco: ‚Äî</div>
        <button class="btnSmall" id="b_banco" type="button">Copiar</button>
      </div>

      <div class="field">
        <div class="chip" id="f_tipo">Tipo: ‚Äî</div>
        <button class="btnSmall" id="b_tipo" type="button">Copiar</button>
      </div>

      <div class="field">
        <div class="chip" id="f_numero">N√∫mero Cuenta: ‚Äî</div>
        <button class="btnSmall" id="b_numero" type="button">Copiar</button>
      </div>

      <div class="field">
        <div class="chip" id="f_correo">Correo: ‚Äî</div>
        <button class="btnSmall" id="b_correo" type="button">Copiar</button>
      </div>

      <p class="hint">
        Tip: Si a√∫n no pega bien, copia y pega primero en <b>Notas</b> y luego desde ah√≠ a tu banco.
      </p>
    </div>

    <div class="small">
      En TuQR solo copias los datos. <b>La transferencia se hace desde tu banco.</b>
    </div>
  </div>

<script>
const params = new URLSearchParams(location.search);
const id = (params.get('id') || '').trim();

const datosEl = document.getElementById('datos');
const btn = document.getElementById('copiar');
const okEl = document.getElementById('ok');
const errEl = document.getElementById('err');
const title = document.getElementById('title');
const tip = document.getElementById('tip');

// ‚ÄúCopiar por campo‚Äù
const fieldsWrap = document.getElementById('fields');
const f_nombre = document.getElementById('f_nombre');
const f_rut = document.getElementById('f_rut');
const f_banco = document.getElementById('f_banco');
const f_tipo = document.getElementById('f_tipo');
const f_numero = document.getElementById('f_numero');
const f_correo = document.getElementById('f_correo');

const b_nombre = document.getElementById('b_nombre');
const b_rut = document.getElementById('b_rut');
const b_banco = document.getElementById('b_banco');
const b_tipo = document.getElementById('b_tipo');
const b_numero = document.getElementById('b_numero');
const b_correo = document.getElementById('b_correo');

// UA detections (solo para mostrar tip)
const ua = navigator.userAgent || '';
const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
const isSamsung = /SamsungBrowser/i.test(ua);
const isInAppWebView = /(FBAN|FBAV|Instagram|Line|Twitter|WhatsApp|wv)/i.test(ua);

// Limpieza ultra estricta para ‚Äútexto tipo WhatsApp‚Äù
function clean(s) {
  return String(s ?? '')
    .normalize('NFC')
    .replace(/\u00A0/g, ' ')                 // NBSP
    .replace(/[\u200B-\u200D\uFEFF]/g, '')   // zero-width + BOM
    .replace(/\r\n/g, '\n')
    .replace(/\r/g, '\n')
    .replace(/[ \t]+$/gm, '')                // trim fin de l√≠nea
    .trim();
}

// ‚úÖ Formato WhatsApp (multil√≠nea)
function buildText(d) {
  const nombre = clean(d.nombre);
  const rut = clean(d.rut);
  const banco = clean(d.banco);
  const tipo = clean(d.tipoCuenta);
  const numero = clean(d.numeroCuenta);
  const correo = d.correo ? clean(d.correo) : '';

  let text =
`Nombre: ${nombre}
Rut: ${rut}
Banco: ${banco}
Tipo: ${tipo}
N√∫mero Cuenta: ${numero}`;

  if (correo) text += `\nCorreo: ${correo}`;
  return text;
}

// Copiado universal robusto (texto plano)
async function copyTextUniversal(text) {
  if (navigator.clipboard && window.isSecureContext) {
    await navigator.clipboard.writeText(text);
    return;
  }

  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.setAttribute('readonly', '');
    ta.style.position = 'fixed';
    ta.style.top = '0';
    ta.style.left = '0';
    ta.style.opacity = '0';
    document.body.appendChild(ta);

    ta.focus();
    ta.select();
    ta.setSelectionRange(0, ta.value.length);

    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    if (ok) return;
  } catch(e) {}

  const el = document.createElement('div');
  el.textContent = text;
  el.contentEditable = 'true';
  el.style.position = 'fixed';
  el.style.top = '0';
  el.style.left = '0';
  el.style.opacity = '0';
  document.body.appendChild(el);

  const range = document.createRange();
  range.selectNodeContents(el);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);

  const ok2 = document.execCommand('copy');
  document.body.removeChild(el);
  if (!ok2) throw new Error('copy_failed');
}

function showCopied() {
  okEl.style.display = 'block';
  setTimeout(() => okEl.style.display = 'none', 1200);
}

let currentText = '';
let currentFields = null;

function setFieldUI(labelEl, label, value) {
  labelEl.textContent = `${label}: ${value || '‚Äî'}`;
}

function attachFieldCopy(buttonEl, value, fieldName) {
  buttonEl.addEventListener('click', async () => {
    try {
      await copyTextUniversal(value || '');
      showCopied();
      gtag('event', 'copy_field_click', { merchant_id: id, field: fieldName });
    } catch(e) {
      alert('No pudimos copiar autom√°ticamente. Mant√©n presionado el texto y selecciona ‚ÄúCopiar‚Äù.');
    }
  });
}

async function init() {
  try {
    const res = await fetch('./data.json', { cache: 'no-store' });
    const all = await res.json();
    const d = all[id];

    if (!id || !d) {
      datosEl.textContent = 'C√≥digo inv√°lido';
      errEl.style.display = 'block';
      btn.disabled = true;
      return;
    }

    const nombre = clean(d.nombre);
    const rut = clean(d.rut);
    const banco = clean(d.banco);
    const tipo = clean(d.tipoCuenta);
    const numero = clean(d.numeroCuenta);
    const correo = d.correo ? clean(d.correo) : '';

    title.textContent = `Paga a ${nombre}`;

    // Texto bloque
    currentText = buildText(d);
    datosEl.textContent = currentText;

    // Campos individuales
    currentFields = { nombre, rut, banco, tipo, numero, correo };

    setFieldUI(f_nombre, 'Nombre', nombre);
    setFieldUI(f_rut, 'Rut', rut);
    setFieldUI(f_banco, 'Banco', banco);
    setFieldUI(f_tipo, 'Tipo', tipo);
    setFieldUI(f_numero, 'N√∫mero Cuenta', numero);
    setFieldUI(f_correo, 'Correo', correo);

    // Si no hay correo, ocultamos su fila (no molesta)
    if (!correo) {
      f_correo.parentElement.style.display = 'none';
    } else {
      f_correo.parentElement.style.display = 'grid';
    }

    // Activar bot√≥n principal
    btn.disabled = false;

    // GA4
    gtag('event', 'payer_page_view', { merchant_id: id });

    // Tip solo donde suele fallar pegar
    if (isIOS || isSamsung || isInAppWebView) tip.style.display = 'block';

    // Mostrar secci√≥n de campos
    fieldsWrap.style.display = 'block';

    // Copiar bloque completo (recalcula desde pantalla por seguridad)
    btn.addEventListener('click', async () => {
      try {
        const textToCopy = datosEl.textContent || currentText || '';
        await copyTextUniversal(textToCopy);
        showCopied();
        gtag('event', 'copy_click', { merchant_id: id });
      } catch(e) {
        alert('No pudimos copiar autom√°ticamente. Mant√©n presionado el texto y selecciona ‚ÄúCopiar‚Äù.');
      }
    });

    // Copiar por campo (uno a uno)
    attachFieldCopy(b_nombre, nombre, 'nombre');
    attachFieldCopy(b_rut, rut, 'rut');
    attachFieldCopy(b_banco, banco, 'banco');
    attachFieldCopy(b_tipo, tipo, 'tipo');
    attachFieldCopy(b_numero, numero, 'numero_cuenta');
    attachFieldCopy(b_correo, correo, 'correo');

  } catch(e) {
    datosEl.textContent = 'Error cargando datos';
    errEl.style.display = 'block';
    btn.disabled = true;
  }
}

init();
</script>

</body>
</html>
