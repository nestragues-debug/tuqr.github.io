<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TuQR — Datos para transferir</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D9TN01T1R0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-D9TN01T1R0');
  </script>

  <style>
    :root { color-scheme: light dark; }
    html, body {
      margin:0; padding:0; height:100%;
      background:#fff; color:#111;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .card{
      max-width:640px; margin:8px auto; padding:20px 16px 28px;
      border:1px solid #eee; border-radius:16px; background:#fff;
      box-shadow: 0 1px 2px rgba(0,0,0,.03);
    }
    h1{ font-size:22px; margin:0 0 8px; font-weight:800; color:#222; }
    p{ margin:0 0 14px; color:#444; }
    pre#datos{
      background:#f6f6f6; padding:14px; border-radius:12px;
      white-space:pre-wrap; word-break:break-word;
      font-size:15px; line-height:1.28; min-height:112px;
      user-select:text; -webkit-user-select:text; -ms-user-select:text;
    }
    button{
      width:100%; padding:16px; font-size:17px; font-weight:700;
      border:0; border-radius:12px; cursor:pointer;
      background:#0078ff; color:#fff; -webkit-tap-highlight-color: transparent;
    }
    button:active{ filter: brightness(0.95); }
    button:disabled{ background:#999; cursor:not-allowed; }
    .ok{ margin-top:10px; color:#0a7; font-weight:700; display:none; }
    .err{ margin-top:10px; color:#b00; font-weight:700; display:none; }
    .tip{ margin-top:10px; font-size:12px; color:#666; display:none; }
    .tip b{ color:#333; }
    .small{ margin-top:12px; font-size:12px; color:#777; }

    /* Copiar por campo (Plan B) */
    .byfield-wrap{
      margin-top:16px; border-top:1px dashed #e5e5e5; padding-top:12px;
    }
    .byfield-title{ font-size:13px; color:#555; font-weight:700; margin:0 0 8px; }
    .grid{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    @media (min-width:560px){ .grid{ grid-template-columns: 1fr 1fr 1fr; } }
    .btn-small{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px; font-size:14px; font-weight:700; line-height:1.1;
      border-radius:10px; border:1px solid #e5e5e5; background:#fafafa; color:#222;
    }
    .btn-small:active{ filter: brightness(0.97); }
  </style>
</head>

<body>
  <div class="card">
    <h1 id="title">Paga con transferencia</h1>
    <p>Copia y pega estos datos en tu aplicación bancaria.</p>

    <!-- Bloque visible con etiquetas -->
    <pre id="datos">Cargando…</pre>

    <!-- Botón principal -->
    <button id="copiar" disabled>Copiar datos para transferir</button>

    <div id="ok" class="ok">Copiado</div>
    <div id="err" class="err">No encontramos este cobrador</div>

    <div id="tip" class="tip">
      Si tu app no pega todo, intenta pegar primero en <b>Notas</b> y volver a copiar. Tambien puedes usar copiar por campo.
    </div>

    <!-- Plan B: copiar por campo -->
    <div id="byfield" class="byfield-wrap" style="display:none;">
      <div class="byfield-title">¿Falto algo? Copia por campo:</div>
      <div class="grid" id="byfield-grid"><!-- Botones por campo --></div>
    </div>

    <div class="small">
      En TuQR solo copias los datos. <b>La transferencia se hace desde tu banco.</b>
    </div>
  </div>

  <script>
    // --- Parámetros / elementos ---
    const params = new URLSearchParams(location.search);
    const id = (params.get('id') || '').trim();

    const datosEl = document.getElementById('datos');
    const btn = document.getElementById('copiar');
    const okEl = document.getElementById('ok');
    const errEl = document.getElementById('err');
    const title = document.getElementById('title');
    const tip = document.getElementById('tip');
    const byFieldWrap = document.getElementById('byfield');
    const byFieldGrid = document.getElementById('byfield-grid');

    // Detecciones para hints
    const ua = navigator.userAgent || '';
    const isIOS =
      /iPad|iPhone|iPod/.test(ua) ||
      (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isSamsung = /SamsungBrowser/i.test(ua);
    const isInAppWebView = /(FBAN|FBAV|Instagram|Line|Twitter|WhatsApp|wv|MACH)/i.test(ua);

    // --- Sanitización de datos ---
    // Limpieza base (NBSP, zero-width, saltos, trims)
    function cleanBase(s) {
      return String(s ?? '')
        .normalize('NFC')
        .replace(/\u00A0/g, ' ')                 // NBSP
        .replace(/[\u200B-\u200D\uFEFF]/g, '')   // Zero-width + BOM
        .replace(/\u2018|\u2019/g, "'")          // comillas tipográficas -> '
        .replace(/\u201C|\u201D/g, '"')          // comillas tipográficas -> "
        .replace(/\u2013|\u2014/g, '-')          // guiones largos -> -
        .replace(/\r\n/g, '\n')                  // normaliza internamente a \n
        .replace(/\r/g, '\n')
        .replace(/[ \t]+$/gm, '')                // trim fin de línea
        .trim();
    }

    // Reglas solicitadas:
    // - ñ/Ñ -> N (mayúscula)
    // - remover diacríticos (tildes/diéresis) de vocales (y en general)
    function sanitizeValue(s) {
      // Primero convertimos ñ/Ñ de forma explícita
      let t = cleanBase(s).replace(/ñ/g, 'N').replace(/Ñ/g, 'N');
      // Luego removemos marcas diacríticas (NFD + strip)
      t = t.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      return t;
    }

    // Etiquetas visibles (sin diacríticos)
    const LABELS_DISPLAY = {
      nombre: 'Nombre',
      rut: 'RUT',
      banco: 'Banco',
      tipoCuenta: 'Tipo de cuenta',
      numeroCuenta: 'Numero de cuenta',
      correo: 'Correo'
    };

    // Etiquetas TSV (ASCII/UPPERCASE)
    const LABELS_TSV = {
      nombre: 'NOMBRE',
      rut: 'RUT',
      banco: 'BANCO',
      tipoCuenta: 'TIPO DE CUENTA',
      numeroCuenta: 'NUMERO DE CUENTA',
      correo: 'CORREO'
    };

    // Bloque visible (para <pre>)
    function buildDisplayLines(d) {
      const nombre = sanitizeValue(d.nombre);
      const rut    = sanitizeValue(d.rut);
      const banco  = sanitizeValue(d.banco);
      const tipo   = sanitizeValue(d.tipoCuenta);
      const numero = sanitizeValue(d.numeroCuenta);
      const correo = d.correo ? sanitizeValue(d.correo) : '';

      const lines = [
        `${LABELS_DISPLAY.nombre}: ${nombre}`,
        `${LABELS_DISPLAY.rut}: ${rut}`,
        `${LABELS_DISPLAY.banco}: ${banco}`,
        `${LABELS_DISPLAY.tipoCuenta}: ${tipo}`,
        `${LABELS_DISPLAY.numeroCuenta}: ${numero}`,
      ];
      if (correo) lines.push(`${LABELS_DISPLAY.correo}: ${correo}`);
      return lines;
    }

    // text/plain como TSV (CLAVE<TAB>VALOR), para parsers de apps bancarias
    function buildTSVLines(d) {
      const nombre = sanitizeValue(d.nombre);
      const rut    = sanitizeValue(d.rut);
      const banco  = sanitizeValue(d.banco);
      const tipo   = sanitizeValue(d.tipoCuenta);
      const numero = sanitizeValue(d.numeroCuenta);
      const correo = d.correo ? sanitizeValue(d.correo) : '';

      const tsv = [
        `${LABELS_TSV.nombre}\t${nombre}`,
        `${LABELS_TSV.rut}\t${rut}`,
        `${LABELS_TSV.banco}\t${banco}`,
        `${LABELS_TSV.tipoCuenta}\t${tipo}`,
        `${LABELS_TSV.numeroCuenta}\t${numero}`,
      ];
      if (correo) tsv.push(`${LABELS_TSV.correo}\t${correo}`);
      return tsv;
    }

    // Unir con CRLF en iOS; \n en otros
    function joinPlain(lines) {
      const sep = isIOS ? '\r\n' : '\n';
      return lines.join(sep);
    }

    // text/html como tabla (varios webviews respetan mejor celdas -> pares)
    function buildHTMLTableFromTSV(tsvLines) {
      const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const rows = tsvLines.map(line => {
        const [k, v] = String(line).split('\t');
        return `<tr><td>${esc(k || '')}</td><td>${esc(v || '')}</td></tr>`;
      }).join('');
      return `<table><tbody>${rows}</tbody></table>`;
    }

    // Copiado multiformato con fallbacks
    async function copyMultiFormat({ textPlain, htmlText }) {
      // 1) ClipboardItem (text/plain + text/html)
      if (navigator.clipboard && window.ClipboardItem) {
        try {
          const item = new ClipboardItem({
            'text/plain': new Blob([textPlain], { type: 'text/plain' }),
            'text/html':  new Blob([htmlText],  { type: 'text/html'  }),
          });
          await navigator.clipboard.write([item]);
          return true;
        } catch (e) { /* fallback */ }
      }
      // 2) writeText (solo texto)
      if (navigator.clipboard && window.isSecureContext) {
        try {
          await navigator.clipboard.writeText(textPlain);
          return true;
        } catch (e) { /* fallback */ }
      }
      // 3) textarea + execCommand('copy')
      try {
        const ta = document.createElement('textarea');
        ta.value = textPlain;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.top = '-1000px';
        ta.style.opacity = '0';
        document.body.appendChild(ta);

        ta.focus();
        ta.select();
        ta.setSelectionRange(0, ta.value.length);

        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        if (ok) return true;
      } catch (e) { /* fallback */ }

      // 4) contentEditable + execCommand con HTML
      try {
        const el = document.createElement('div');
        el.contentEditable = 'true';
        el.style.position = 'fixed';
        el.style.top = '-1000px';
        el.style.opacity = '0';
        el.innerHTML = htmlText;
        document.body.appendChild(el);

        const range = document.createRange();
        range.selectNodeContents(el);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);

        const ok2 = document.execCommand('copy');
        document.body.removeChild(el);
        if (ok2) return true;
      } catch (e) {}

      return false;
    }

    function showCopied() {
      okEl.style.display = 'block';
      setTimeout(() => okEl.style.display = 'none', 1500);
    }

    // Plan B: botones por campo
    function renderByFieldButtons(d) {
      const fields = [
        { key:'nombre', label: LABELS_DISPLAY.nombre, value: sanitizeValue(d.nombre) },
        { key:'rut',    label: LABELS_DISPLAY.rut,    value: sanitizeValue(d.rut) },
        { key:'banco',  label: LABELS_DISPLAY.banco,  value: sanitizeValue(d.banco) },
        { key:'tipo',   label: LABELS_DISPLAY.tipoCuenta, value: sanitizeValue(d.tipoCuenta) },
        { key:'numero', label: LABELS_DISPLAY.numeroCuenta, value: sanitizeValue(d.numeroCuenta) },
      ];
      if (d.correo) fields.push({ key:'correo', label: LABELS_DISPLAY.correo, value: sanitizeValue(d.correo) });

      byFieldGrid.innerHTML = '';
      fields.forEach(f => {
        if (!f.value) return;
        const b = document.createElement('button');
        b.className = 'btn-small';
        b.type = 'button';
        b.textContent = `Copiar ${f.label}`;
        b.addEventListener('click', async () => {
          const textPlain = f.value;
          const htmlText  = `<div>${String(f.value)
                                .replace(/&/g,'&amp;')
                                .replace(/</g,'&lt;')
                                .replace(/>/g,'&gt;')}</div>`;
          try {
            const ok = await copyMultiFormat({ textPlain, htmlText });
            if (!ok) throw new Error('copy_failed');
            showCopied();
            gtag('event', 'copy_field', { merchant_id: id, field: f.key });
          } catch (e) {
            alert('No pudimos copiar automaticamente. Manten presionado el texto y selecciona "Copiar".');
          }
        });
        byFieldGrid.appendChild(b);
      });

      byFieldWrap.style.display = 'block';
    }

    let cachedD = null;

    async function init() {
      try {
        const res = await fetch('./data.json', { cache: 'no-store' });
        const all = await res.json();
        const d = all[id];
        cachedD = d;

        if (!id || !d) {
          datosEl.textContent = 'Codigo invalido';
          errEl.style.display = 'block';
          btn.disabled = true;
          return;
        }

        // Titulo (nombre saneado)
        title.textContent = `Paga a ${sanitizeValue(d.nombre)}`;

        // Construir bloque visible y payload de copiado
        const displayLines = buildDisplayLines(d);   // visible
        const tsvLines     = buildTSVLines(d);       // text/plain TSV
        const plainText    = joinPlain(tsvLines);
        const htmlText     = buildHTMLTableFromTSV(tsvLines);

        // Mostrar bloque legible
        datosEl.textContent = joinPlain(displayLines);

        // Habilitar botón principal
        btn.disabled = false;

        // GA4
        gtag('event', 'payer_page_view', { merchant_id: id });

        // Tip en entornos más friccionados
        if (isIOS || isSamsung || isInAppWebView) tip.style.display = 'block';

        // Botón principal
        btn.addEventListener('click', async () => {
          try {
            const d0 = cachedD || d;
            const tsv = buildTSVLines(d0);
            const ok = await copyMultiFormat({
              textPlain: joinPlain(tsv),
              htmlText : buildHTMLTableFromTSV(tsv)
            });
            if (!ok) throw new Error('copy_failed');

            showCopied();
            gtag('event', 'copy_click', { merchant_id: id });
          } catch (e) {
            alert('No pudimos copiar automaticamente. Manten presionado el texto y selecciona "Copiar".');
          }
        });

        // Plan B
        renderByFieldButtons(d);

      } catch (e) {
        datosEl.textContent = 'Error cargando datos';
        errEl.style.display = 'block';
        btn.disabled = true;
      }
    }

    init();
  </script>
</body>
</html>
