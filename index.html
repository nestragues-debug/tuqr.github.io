<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TuQR — Ir a WhatsApp</title>

  <!-- GA4 -->
  https://www.googletagmanager.com/gtag/js?id=G-CTV8Y0DJTR</script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config','G-CTV8Y0DJTR');
  </script>

  <style>
    :root { color-scheme: light dark; }
    body{
      margin:0; padding:24px; background:#fff; color:#111;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .card{
      max-width:520px; margin:0 auto; border:1px solid #eee; border-radius:16px;
      background:#fff; padding:20px 18px 24px; box-shadow:0 1px 2px rgba(0,0,0,.03);
    }
    h1{ font-size:22px; margin:0 0 8px; font-weight:800; color:#222; }
    p{ margin:0 0 14px; color:#444; }
    .info{
      background:#f6f6f6; border-radius:12px; padding:12px; font-size:14px; color:#333;
      word-break:break-word;
    }
    .kvs{ margin:10px 0 0; font-size:13px; color:#555; }
    .kvs b{ color:#222; }
    .cta{
      margin-top:16px;
      width:100%; padding:16px; font-size:17px; font-weight:700; line-height:1.1;
      border:0; border-radius:12px; cursor:pointer; background:#25D366; color:#fff;
    }
    .cta:disabled{ background:#9adab8; cursor:not-allowed; }
    .cta:active{ filter:brightness(0.97); }
    .err{ margin-top:10px; color:#b00; font-weight:700; display:none; }
    .ok{ margin-top:10px; color:#0a7; font-weight:700; display:none; }
    .small{ margin-top:12px; font-size:12px; color:#777; }
    .hint{ font-size:12px; color:#666; margin-top:8px; }
    .sep{ height:1px; background:#eee; margin:16px 0; }
  </style>
</head>
<body>
  <div class="card">
    <h1 id="title">Paga con transferencia</h1>
    <p>Abre WhatsApp para continuar.</p>

    <div id="info" class="info">
      <div>Comercio: <b id="merchantLabel">—</b></div>
      <div class="kvs">
        <div>Destino: <b id="waTarget">—</b></div>
        <div id="builtLine" style="display:none;">Mensaje: <b id="waText">—</b></div>
      </div>
    </div>

    <button id="toWhatsApp" class="cta" disabled>Abrir WhatsApp</button>

    <div id="ok" class="ok">Listo. Abriendo WhatsApp…</div>
    <div id="err" class="err">No pudimos preparar el enlace a WhatsApp.</div>

    <div class="sep"></div>
    <div class="small">
      En TuQR solo se inicia la conversación. El pagador debe enviar el primer mensaje en WhatsApp. Luego tú respondes manualmente con los datos del comercio.
    </div>
    <div class="hint" id="hint" style="display:none;">
      Sugerencia: puedes pasar <code>&wa=</code> con tu link completo <code>wa.me</code> (opcional). Por defecto, esta landing construye el mensaje con tu número fijo.
    </div>
  </div>

  <script>
    // ---------------------------
    // Configuración: tu número fijo de WhatsApp (formato internacional, sin + ni símbolos)
    // ---------------------------
    const DEFAULT_PHONE = '56982897919';

    // ---------------------------
    // Utilidades y DOM
    // ---------------------------
    const qs = new URLSearchParams(location.search);
    const id = (qs.get('id') || '').trim();             // merchant_id (ej.: BCICorriente)
    const waParam = (qs.get('wa') || '').trim();        // link wa.me completo (opcional)

    const titleEl   = document.getElementById('title');
    const infoEl    = document.getElementById('info');
    const okEl      = document.getElementById('ok');
    const errEl     = document.getElementById('err');
    const btn       = document.getElementById('toWhatsApp');

    const merchantLabelEl = document.getElementById('merchantLabel');
    const waTargetEl      = document.getElementById('waTarget');
    const builtLine       = document.getElementById('builtLine');
    const waTextEl        = document.getElementById('waText');
    const hintEl          = document.getElementById('hint');

    function clean(s){
      return String(s ?? '')
        .normalize('NFC')
        .replace(/\u00A0/g, ' ')
        .replace(/[\u200B-\u200F]/g, '')
        .replace(/\r\n/g, '\n').replace(/\r/g, '\n')
        .replace(/[ \t]+$/gm, '')
        .trim();
    }
    function isValidIntlNumber(n){ return /^[0-9]{8,15}$/.test(n); }

    function buildWaLink(phone, merchantId){
      const msg = 'OK ' + merchantId;
      const enc = encodeURIComponent(msg);
      return `https://wa.me/${phone}?text=${enc}`;
    }

    // ---------------------------
    // Init
    // ---------------------------
    (function init(){
      try{
        const merchantId = clean(id);
        if (!merchantId) {
          infoEl.innerHTML = 'Falta el parámetro <b>id</b> en la URL.';
          errEl.style.display = 'block';
          btn.disabled = true;
          hintEl.style.display = 'block';
          return;
        }

        // Títulos
        titleEl.textContent = `Paga a ${merchantId}`;
        document.title      = `TuQR - ${merchantId}`;
        merchantLabelEl.textContent = merchantId;

        let waLinkFinal = '';
        let built = false;

        if (waParam) {
          // Si nos pasas el wa.me directo en ?wa=, respetamos ese enlace
          waLinkFinal = clean(waParam);
        } else {
          // Construimos con tu número fijo
          const phone = DEFAULT_PHONE;
          if (!isValidIntlNumber(phone)) {
            infoEl.innerHTML = 'El número configurado no es válido (usa solo dígitos en formato internacional, sin +).';
            errEl.style.display = 'block';
            btn.disabled = true;
            hintEl.style.display = 'block';
            return;
          }
          waLinkFinal = buildWaLink(phone, merchantId);
          built = true;
        }

        // Mostrar destino y mensaje (si lo construimos aquí)
        waTargetEl.textContent = waLinkFinal;
        if (built) {
          builtLine.style.display = 'block';
          waTextEl.textContent = 'OK ' + merchantId;
        }

        // Habilitar CTA
        btn.disabled = false;

        // GA4: vista por pagador
        try {
          gtag('event','payer_page_view', {
            merchant_id: merchantId,
            page_path: location.pathname + location.search,
            page_title: document.title
          });
        } catch(e){}

        // Click a WhatsApp
        btn.addEventListener('click', () => {
          try {
            const host = (()=>{ try{ return (new URL(waLinkFinal)).host || 'wa.me'; }catch(e){ return 'wa.me'; }})();
            gtag('event','open_whatsapp', { merchant_id: merchantId, wa_mode: waParam ? 'direct' : 'built', wa_host: host });
          } catch(e){}
          okEl.style.display = 'block';
          location.href = waLinkFinal;
        });

      } catch(e){
        infoEl.innerHTML = 'Error preparando el enlace a WhatsApp.';
        errEl.style.display = 'block';
        btn.disabled = true;
        hintEl.style.display = 'block';
      }
    })();
  </script>
</body>
</html>
