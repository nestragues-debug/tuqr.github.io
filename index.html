<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>TuQR ‚Äî Datos para transferir</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D9TN01T1R0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-D9TN01T1R0');
  </script>

  <style>
    body{
      font-family: system-ui, -apple-system, Arial;
      margin:0; padding:24px; background:#fff;
      -webkit-text-size-adjust: 100%;
    }
    .card{
      max-width:520px; margin:0 auto;
      border:1px solid #eee; border-radius:16px; padding:18px;
    }
    h1{ font-size:22px; margin:0 0 8px; }
    p{ margin:0 0 14px; color:#444; }
    pre{
      background:#f6f6f6; padding:14px; border-radius:12px;
      white-space:pre-wrap; word-break:break-word;
      font-size:15px;
      user-select:text; -webkit-user-select:text;
    }
    button{
      width:100%; padding:16px; font-size:18px;
      border:0; border-radius:12px; cursor:pointer;
      background:#0078ff; color:#fff; font-weight:600;
    }
    button:disabled{ background:#999; cursor:not-allowed; }
    .ok{ margin-top:10px; color:#0a7; font-weight:700; display:none; }
    .err{ margin-top:10px; color:#b00; font-weight:700; display:none; }
    .small{ margin-top:12px; font-size:12px; color:#777; }

    /* ‚úÖ Botones por campo (grilla 2 columnas) */
    .fields{
      margin-top:18px;
      border-top:1px solid #eee;
      padding-top:14px;
      display:none;
    }
    .fields h2{
      font-size:14px;
      margin:0 0 10px;
      color:#333;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btnField{
      width:100%;
      padding:12px 10px;
      font-size:14px;
      border-radius:12px;
      background:#111;
      color:#fff;
      font-weight:700;
    }
    .hint{
      margin:10px 0 0;
      font-size:12px;
      color:#666;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1 id="title">Paga con transferencia</h1>
    <p>Copia y pega estos datos en tu aplicaci√≥n bancaria 22:15.</p>

    <pre id="visual">Cargando‚Ä¶</pre>

    <button id="copyAll" disabled>üìã Copiar datos para transferir</button>

    <div id="ok" class="ok">Copiado ‚úÖ</div>
    <div id="err" class="err">No encontramos este cobrador</div>

    <!-- ‚úÖ Botones por campo (sin mostrar valores) -->
    <div id="fields" class="fields">
      <h2>¬øTu banco peg√≥ incompleto? Copia campo por campo:</h2>
      <div class="grid">
        <button class="btnField" id="b_nombre" type="button">Copiar Nombre</button>
        <button class="btnField" id="b_rut" type="button">Copiar Rut</button>
        <button class="btnField" id="b_banco" type="button">Copiar Banco</button>
        <button class="btnField" id="b_tipo" type="button">Copiar Tipo</button>
        <button class="btnField" id="b_numero" type="button">Copiar N√∫mero</button>
        <button class="btnField" id="b_correo" type="button">Copiar Correo</button>
      </div>
      <p class="hint">Tip: si a√∫n falla, pega primero en <b>Notas</b> y luego desde ah√≠ a tu banco.</p>
    </div>

    <div class="small">
      En TuQR solo copias los datos. <b>La transferencia se hace desde tu banco.</b>
    </div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const id = (params.get('id') || '').trim();

  const titleEl = document.getElementById('title');
  const visualEl = document.getElementById('visual');
  const copyAllBtn = document.getElementById('copyAll');
  const okEl = document.getElementById('ok');
  const errEl = document.getElementById('err');
  const fieldsWrap = document.getElementById('fields');

  const b_nombre = document.getElementById('b_nombre');
  const b_rut = document.getElementById('b_rut');
  const b_banco = document.getElementById('b_banco');
  const b_tipo = document.getElementById('b_tipo');
  const b_numero = document.getElementById('b_numero');
  const b_correo = document.getElementById('b_correo');

  function clean(s) {
    return String(s ?? '')
      .normalize('NFC')
      .replace(/\u00A0/g, ' ')
      .replace(/[\u200B-\u200D\uFEFF]/g, '')
      .replace(/\r\n/g, '\n')
      .replace(/\r/g, '\n')
      .replace(/[ \t]+$/gm, '')
      .trim();
  }

  function showCopied() {
    okEl.style.display = 'block';
    setTimeout(() => okEl.style.display = 'none', 1200);
  }

  // ‚úÖ Copiado robusto + evita zoom: no dejamos foco en textarea
  async function copyTextUniversal(text) {
    const t = String(text || '');

    // 1) Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(t);
      return;
    }

    // 2) Fallback con textarea temporal (se crea, copia, se elimina y blur)
    const prevScrollY = window.scrollY;
    const ta = document.createElement('textarea');
    ta.value = t;
    ta.setAttribute('readonly', '');
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    ta.style.top = '0';
    ta.style.opacity = '0';
    ta.style.fontSize = '16px'; // clave para evitar zoom iOS
    document.body.appendChild(ta);

    ta.focus();
    ta.select();
    ta.setSelectionRange(0, ta.value.length);

    const ok = document.execCommand('copy');
    document.body.removeChild(ta);

    // quitar foco para evitar zoom persistente
    if (document.activeElement && typeof document.activeElement.blur === 'function') {
      document.activeElement.blur();
    }
    window.scrollTo(0, prevScrollY);

    if (!ok) throw new Error('copy_failed');
  }

  function buildBlock(d) {
    let text =
`Nombre: ${d.nombre}
Rut: ${d.rut}
Banco: ${d.banco}
Tipo: ${d.tipoCuenta}
N√∫mero Cuenta: ${d.numeroCuenta}`;
    if (d.correo) text += `\nCorreo: ${d.correo}`;
    return text;
  }

  function wireFieldButton(btn, value, fieldName) {
    btn.addEventListener('click', async () => {
      try {
        await copyTextUniversal(value || '');
        showCopied();
        gtag('event', 'copy_field_click', { merchant_id: id, field: fieldName });
      } catch(e) {
        alert('No pudimos copiar autom√°ticamente. Mant√©n presionado y selecciona ‚ÄúCopiar‚Äù.');
      }
    });
  }

  async function init() {
    try {
      const res = await fetch('./data.json', { cache: 'no-store' });
      const all = await res.json();
      const raw = all[id];

      if (!id || !raw) {
        visualEl.textContent = 'C√≥digo inv√°lido';
        errEl.style.display = 'block';
        copyAllBtn.disabled = true;
        return;
      }

      const d = {
        nombre: clean(raw.nombre),
        rut: clean(raw.rut),
        banco: clean(raw.banco),
        tipoCuenta: clean(raw.tipoCuenta),
        numeroCuenta: clean(raw.numeroCuenta),
        correo: raw.correo ? clean(raw.correo) : ''
      };

      titleEl.textContent = `Paga a ${d.nombre}`;

      const block = buildBlock(d);
      visualEl.textContent = block;

      copyAllBtn.disabled = false;
      copyAllBtn.addEventListener('click', async () => {
        try {
          await copyTextUniversal(block);
          showCopied();
          gtag('event', 'copy_click', { merchant_id: id });
        } catch(e) {
          alert('No pudimos copiar autom√°ticamente. Mant√©n presionado el texto y selecciona ‚ÄúCopiar‚Äù.');
        }
      });

      // Mostrar grilla de botones
      fieldsWrap.style.display = 'block';

      // Botones por campo (sin mostrar valores)
      wireFieldButton(b_nombre, d.nombre, 'nombre');
      wireFieldButton(b_rut, d.rut, 'rut');
      wireFieldButton(b_banco, d.banco, 'banco');
      wireFieldButton(b_tipo, d.tipoCuenta, 'tipo');
      wireFieldButton(b_numero, d.numeroCuenta, 'numero_cuenta');

      if (d.correo) {
        b_correo.style.display = 'block';
        wireFieldButton(b_correo, d.correo, 'correo');
      } else {
        b_correo.style.display = 'none';
      }

      gtag('event', 'payer_page_view', { merchant_id: id });

    } catch(e) {
      visualEl.textContent = 'Error cargando datos';
      errEl.style.display = 'block';
      copyAllBtn.disabled = true;
    }
  }

  init();
</script>

</body>
</html>
