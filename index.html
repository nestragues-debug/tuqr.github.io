<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TuQR â€” Datos para transferir</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D9TN01T1R0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D9TN01T1R0');
  </script>

  <style>
    body { font-family: system-ui, -apple-system, Arial; margin: 0; padding: 24px; background:#fff; }
    .card { max-width: 520px; margin: 0 auto; border: 1px solid #eee; border-radius: 16px; padding: 18px; }
    h1 { font-size: 22px; margin: 0 0 8px; }
    p { margin: 0 0 14px; color: #444; }
    pre { background: #f6f6f6; padding: 14px; border-radius: 12px; white-space: pre-wrap; word-break: break-word; font-size: 15px; }
    button { width: 100%; padding: 14px; font-size: 18px; border: 0; border-radius: 12px; cursor: pointer; }
    .ok { margin-top: 10px; color: #0a7; font-weight: 700; display:none; }
    .err { margin-top: 10px; color: #b00; font-weight: 700; display:none; }
    .small { margin-top: 12px; font-size: 12px; color: #777; }
    .tip { margin-top: 10px; font-size: 12px; color: #666; display:none; }
    .tip b { color:#333; }
  </style>
</head>

<body>
  <div class="card">
    <h1 id="title">Paga con transferencia</h1>
    <p>Copia y pega estos datos en tu aplicaciÃ³n bancaria.</p>

    <pre id="datos">Cargandoâ€¦</pre>

    <button id="copiar" disabled>ðŸ“‹ Copiar datos para transferir</button>
    <div id="ok" class="ok">Copiado âœ…</div>
    <div id="err" class="err">No encontramos este cobrador</div>

    <div id="tip" class="tip">
      Si tu app no deja pegar el bloque completo (pasa en algunas), pega primero en <b>Notas</b> y luego vuelve a copiar desde ahÃ­.
    </div>

    <div class="small">TuQR solo muestra datos. La transferencia se hace en tu banco.</div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const id = (params.get('id') || '').trim();

    const datosEl = document.getElementById('datos');
    const btn = document.getElementById('copiar');
    const okEl = document.getElementById('ok');
    const errEl = document.getElementById('err');
    const title = document.getElementById('title');
    const tip = document.getElementById('tip');

    // Detectores simples (para mostrar tip cuando corresponde)
    const ua = navigator.userAgent || '';
    const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isAndroid = /Android/.test(ua);
    const isInAppWebView = /(FBAN|FBAV|Instagram|Line|Twitter|WhatsApp|wv)/i.test(ua);

    // Limpieza: deja texto "tipo WhatsApp": solo texto + saltos de lÃ­nea reales
    function clean(s) {
      return String(s ?? '')
        .normalize('NFC')
        .replace(/\u00A0/g, ' ')      // NBSP -> espacio normal
        .replace(/\r\n/g, '\n')       // CRLF -> LF
        .replace(/[ \t]+$/gm, '')     // sin espacios al final de cada lÃ­nea
        .trim();
    }

    function buildText(d) {
      const lines = [
        `Nombre: ${clean(d.nombre)}`,
        `RUT: ${clean(d.rut)}`,
        `Banco: ${clean(d.banco)}`,
        `Tipo de cuenta: ${clean(d.tipoCuenta)}`,
        `Numero de cuenta: ${clean(d.numeroCuenta)}`
      ];
      return lines.join('\n');
    }

    // Copiado robusto para Android + iOS
    async function copyTextUniversal(text) {
      // A) Clipboard API (mejor en Android Chrome / iOS Safari en HTTPS)
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return { method: 'clipboard' };
      }

      // B) Fallback 1: textarea (suele funcionar bien en iOS/Android)
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.top = '0';
        ta.style.left = '0';
        ta.style.opacity = '0';
        ta.style.width = '1px';
        ta.style.height = '1px';
        ta.style.pointerEvents = 'none';
        document.body.appendChild(ta);

        ta.focus();
        ta.select();
        ta.setSelectionRange(0, ta.value.length); // iOS necesita esto
        const ok = document.execCommand('copy');

        document.body.removeChild(ta);
        if (ok) return { method: 'execCommand-textarea' };
      } catch (e) {}

      // C) Fallback 2 (extra iOS/WebView): contenteditable
      const el = document.createElement('div');
      el.textContent = text;
      el.setAttribute('contenteditable', 'true');
      el.style.position = 'fixed';
      el.style.top = '0';
      el.style.left = '0';
      el.style.opacity = '0';
      el.style.pointerEvents = 'none';
      el.style.whiteSpace = 'pre-wrap';
      document.body.appendChild(el);

      const range = document.createRange();
      range.selectNodeContents(el);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);

      const ok2 = document.execCommand('copy');
      document.body.removeChild(el);

      if (!ok2) throw new Error('copy_failed');
      return { method: 'execCommand-contenteditable' };
    }

    function showCopied() {
      okEl.style.display = 'block';
      setTimeout(() => okEl.style.display = 'none', 1500);
    }

    async function init() {
      try {
        const res = await fetch('./data.json', { cache: 'no-store' });
        const all = await res.json();
        const d = all[id];

        if (!id || !d) {
          datosEl.textContent = 'CÃ³digo invÃ¡lido';
          errEl.style.display = 'block';
          return;
        }

        title.textContent = `Paga a ${clean(d.nombre)}`;
        const text = buildText(d);
        datosEl.textContent = text;
        btn.disabled = false;

        // âœ… registrar visita por cobrador
        gtag('event', 'payer_page_view', { merchant_id: id });

        // Mostrar tip en escenarios donde el pegado suele ser mÃ¡s problemÃ¡tico
        if (isIOS || isInAppWebView) {
          tip.style.display = 'block';
        }

        btn.addEventListener('click', async () => {
          try {
            await copyTextUniversal(text);
            showCopied();

            // âœ… registrar click copiar por cobrador
            gtag('event', 'copy_click', { merchant_id: id });
            gtag('event', 'copy_method', {
              merchant_id: id,
              platform: isIOS ? 'ios' : (isAndroid ? 'android' : 'other'),
              in_app_webview: isInAppWebView ? 'yes' : 'no',
              secure_context: window.isSecureContext ? 'yes' : 'no'
            });

          } catch (e) {
            // Ãšltimo recurso: instrucciÃ³n simple para el usuario
            alert('No pudimos copiar automÃ¡ticamente. MantÃ©n presionado el texto, selecciona "Copiar", y luego pÃ©galo en tu app.');
          }
        });

      } catch (e) {
        datosEl.textContent = 'Error cargando datos';
      }
    }

    init();
  </script>
</body>
</html>
