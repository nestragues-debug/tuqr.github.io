<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>TuQR ‚Äî Datos para transferir</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D9TN01T1R0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-D9TN01T1R0');
  </script>

  <style>
    body{
      font-family: system-ui, -apple-system, Arial;
      margin:0; padding:24px; background:#fff;
      -webkit-text-size-adjust: 100%;
    }
    .card{
      max-width:520px; margin:0 auto;
      border:1px solid #eee; border-radius:16px; padding:18px;
    }
    h1{ font-size:22px; margin:0 0 8px; }
    p{ margin:0 0 14px; color:#444; }

    pre{
      background:#f6f6f6; padding:14px; border-radius:12px;
      white-space:pre-wrap; word-break:break-word;
      font-size:15px;
      user-select:text; -webkit-user-select:text;
    }

    button{
      width:100%; padding:16px; font-size:18px;
      border:0; border-radius:12px; cursor:pointer;
      background:#0078ff; color:#fff; font-weight:600;
      touch-action: manipulation;
    }
    button:disabled{ background:#999; cursor:not-allowed; }

    .ok{ margin-top:10px; color:#0a7; font-weight:700; display:none; }
    .err{ margin-top:10px; color:#b00; font-weight:700; display:none; }
    .small{ margin-top:12px; font-size:12px; color:#777; }

    /* Botones por campo (grilla 2 columnas, sin mostrar valores) */
    .fields{
      margin-top:18px;
      border-top:1px solid #eee;
      padding-top:14px;
      display:none;
    }
    .fields h2{
      font-size:14px;
      margin:0 0 10px;
      color:#333;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btnField{
      width:100%;
      padding:12px 10px;
      font-size:14px;
      border-radius:12px;
      background:#111;
      color:#fff;
      font-weight:700;
    }
    .hint{
      margin:10px 0 0;
      font-size:12px;
      color:#666;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1 id="title">Paga con transferencia</h1>
    <p>Copia y pega estos datos en tu aplicaci√≥n bancaria 22:59.</p>

    <pre id="visual">Cargando‚Ä¶</pre>

    <button id="copyAll" disabled>üìã Copiar datos para transferir</button>

    <div id="ok" class="ok">Copiado ‚úÖ</div>
    <div id="err" class="err">No encontramos este cobrador</div>

    <div id="fields" class="fields">
      <h2>Si tu banco peg√≥ incompleto, copia campo por campo:</h2>
      <div class="grid">
        <button class="btnField" id="b_banco" type="button">Copiar Banco</button>
        <button class="btnField" id="b_tipo" type="button">Copiar Tipo</button>
        <button class="btnField" id="b_cuenta" type="button">Copiar Cuenta</button>
        <button class="btnField" id="b_rut" type="button">Copiar RUT</button>
        <button class="btnField" id="b_nombre" type="button">Copiar Nombre</button>
        <button class="btnField" id="b_correo" type="button">Copiar Correo</button>
      </div>
      <p class="hint">Tip: si a√∫n falla, pega primero en <b>Notas</b> y luego desde ah√≠ a tu banco.</p>
    </div>

    <div class="small">
      En TuQR solo copias los datos. <b>La transferencia se hace desde tu banco.</b>
    </div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const id = (params.get('id') || '').trim();

  const titleEl = document.getElementById('title');
  const visualEl = document.getElementById('visual');
  const copyAllBtn = document.getElementById('copyAll');
  const okEl = document.getElementById('ok');
  const errEl = document.getElementById('err');
  const fieldsWrap = document.getElementById('fields');

  const b_banco = document.getElementById('b_banco');
  const b_tipo = document.getElementById('b_tipo');
  const b_cuenta = document.getElementById('b_cuenta');
  const b_rut = document.getElementById('b_rut');
  const b_nombre = document.getElementById('b_nombre');
  const b_correo = document.getElementById('b_correo');

  function showCopied() {
    okEl.style.display = 'block';
    setTimeout(() => okEl.style.display = 'none', 1200);
  }

  // ====== Limpieza agresiva y ‚ÄúASCII-ficaci√≥n‚Äù ======

  // 1) Normaliza a NFD para separar diacr√≠ticos
  // 2) Reemplaza √±/√ë por n/N expl√≠citamente
  // 3) Elimina diacr√≠ticos (tildes/di√©resis/etc.)
  // 4) Elimina caracteres no-ASCII problem√°ticos
  function toASCII(s) {
    let t = String(s ?? '');

    // espacios raros
    t = t.replace(/\u00A0/g, ' ').replace(/[\u200B-\u200D\uFEFF]/g, '');

    // √±/√ë primero (antes de quitar diacr√≠ticos)
    t = t.replace(/√±/g, 'n').replace(/√ë/g, 'N');

    // quitar tildes/diacr√≠ticos
    t = t.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

    // dejar solo ASCII imprimible b√°sico
    t = t.replace(/[^\x20-\x7E]/g, '');

    // normalizar espacios
    t = t.replace(/\s+/g, ' ').trim();
    return t;
  }

  // Permite letras/n√∫meros/espacios y algunos signos seguros (para campos ‚Äútexto‚Äù)
  function cleanTextField(s) {
    let t = toASCII(s);
    // elimina cosas raras, deja: letras, n√∫meros, espacio y .,-/@():+
    t = t.replace(/[^A-Za-z0-9 .,\-@():+/_]/g, '');
    t = t.replace(/\s+/g, ' ').trim();
    return t;
  }

  // RUT: remove dots, keep digits, K/k, hyphen
  function cleanRut(s) {
    let t = toASCII(s).toUpperCase();
    t = t.replace(/\./g, '');                    // fuera puntos
    t = t.replace(/[^0-9K\-]/g, '');             // solo 0-9 K -
    // deja solo un guion (si hay)
    const parts = t.split('-').filter(Boolean);
    if (parts.length >= 2) t = parts[0] + '-' + parts[1];
    return t.trim();
  }

  // Cuenta: solo d√≠gitos (m√°xima compatibilidad)
  function cleanAccountNumber(s) {
    let t = toASCII(s);
    t = t.replace(/[^0-9]/g, '');
    return t.trim();
  }

  // Email: ascii + caracteres t√≠picos
  function cleanEmail(s) {
    let t = toASCII(s).toLowerCase();
    t = t.replace(/[^a-z0-9@._+\-]/g, '');
    return t.trim();
  }

  // ====== Copiado robusto + anti-zoom ======
  async function copyTextUniversal(text) {
    const t = String(text || '');

    // 1) Clipboard API (mejor)
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(t);
      return;
    }

    // 2) Fallback con textarea temporal (16px para evitar zoom iOS)
    const prevScrollY = window.scrollY;
    const ta = document.createElement('textarea');
    ta.value = t;
    ta.setAttribute('readonly', '');
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    ta.style.top = '0';
    ta.style.opacity = '0';
    ta.style.fontSize = '16px';
    document.body.appendChild(ta);

    ta.focus();
    ta.select();
    ta.setSelectionRange(0, ta.value.length);

    const ok = document.execCommand('copy');
    document.body.removeChild(ta);

    if (document.activeElement && typeof document.activeElement.blur === 'function') {
      document.activeElement.blur();
    }
    window.scrollTo(0, prevScrollY);

    if (!ok) throw new Error('copy_failed');
  }

  // ====== Formato ‚ÄúCopiar todo‚Äù para m√°xima compatibilidad ======
  //  - UNA sola l√≠nea (muchas apps bancarias cortan multilinea)
  //  - Separadores seguros: "; " (evita pipes y s√≠mbolos raros)
  function buildCopyAllLine(d) {
    // Etiquetas simples y consistentes
    // Orden: Banco -> Tipo -> Cuenta -> RUT -> Nombre -> Correo
    const parts = [
      `Banco: ${d.banco}`,
      `Tipo: ${d.tipoCuenta}`,
      `Cuenta: ${d.numeroCuenta}`,
      `RUT: ${d.rut}`,
      `Nombre: ${d.nombre}`
    ];
    if (d.correo) parts.push(`Correo: ${d.correo}`);
    return parts.join('; ');
  }

  // Texto visual (puede ser multil√≠nea para leer f√°cil)
  // Pero el ‚Äúcopiar todo‚Äù usa 1 l√≠nea para compatibilidad.
  function buildVisualText(d) {
    let t =
`Banco: ${d.banco}
Tipo: ${d.tipoCuenta}
Cuenta: ${d.numeroCuenta}
RUT: ${d.rut}
Nombre: ${d.nombre}`;
    if (d.correo) t += `\nCorreo: ${d.correo}`;
    return t;
  }

  function wireFieldButton(btn, value, fieldName) {
    btn.addEventListener('click', async () => {
      try {
        await copyTextUniversal(value || '');
        showCopied();
        gtag('event', 'copy_field_click', { merchant_id: id, field: fieldName });
      } catch(e) {
        alert('No pudimos copiar autom√°ticamente. Mant√©n presionado y selecciona ‚ÄúCopiar‚Äù.');
      }
    });
  }

  async function init() {
    try {
      const res = await fetch('./data.json', { cache: 'no-store' });
      const all = await res.json();
      const raw = all[id];

      if (!id || !raw) {
        visualEl.textContent = 'C√≥digo inv√°lido';
        errEl.style.display = 'block';
        copyAllBtn.disabled = true;
        return;
      }

      // Limpieza + reemplazo de caracteres extra√±os (√±/tildes/etc.)
      const d = {
        nombre: cleanTextField(raw.nombre),
        rut: cleanRut(raw.rut),
        banco: cleanTextField(raw.banco),
        tipoCuenta: cleanTextField(raw.tipoCuenta),
        numeroCuenta: cleanAccountNumber(raw.numeroCuenta),
        correo: raw.correo ? cleanEmail(raw.correo) : ''
      };

      // Title no debe tener caracteres raros
      titleEl.textContent = `Paga a ${d.nombre || 'Beneficiario'}`;

      // Visual (legible)
      visualEl.textContent = buildVisualText(d);

      // Copy All (m√°xima compatibilidad: una l√≠nea)
      const copyAllText = buildCopyAllLine(d);

      copyAllBtn.disabled = false;
      copyAllBtn.addEventListener('click', async () => {
        try {
          await copyTextUniversal(copyAllText);
          showCopied();
          gtag('event', 'copy_click', { merchant_id: id });
        } catch(e) {
          alert('No pudimos copiar autom√°ticamente. Mant√©n presionado el texto y selecciona ‚ÄúCopiar‚Äù.');
        }
      });

      // Mostrar grilla
      fieldsWrap.style.display = 'block';

      // Copiar por campo (valores puros, ya normalizados a ASCII)
      wireFieldButton(b_banco, d.banco, 'banco');
      wireFieldButton(b_tipo, d.tipoCuenta, 'tipo');
      wireFieldButton(b_cuenta, d.numeroCuenta, 'cuenta');
      wireFieldButton(b_rut, d.rut, 'rut');
      wireFieldButton(b_nombre, d.nombre, 'nombre');

      if (d.correo) {
        b_correo.style.display = 'block';
        wireFieldButton(b_correo, d.correo, 'correo');
      } else {
        b_correo.style.display = 'none';
      }

      // GA4
      gtag('event', 'payer_page_view', { merchant_id: id });

    } catch(e) {
      visualEl.textContent = 'Error cargando datos';
      errEl.style.display = 'block';
      copyAllBtn.disabled = true;
    }
  }

  init();
</script>

</body>
</html>
