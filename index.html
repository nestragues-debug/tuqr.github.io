<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TuQR â€” Datos para transferir</title>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D9TN01T1R0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D9TN01T1R0');
  </script>

  <style>
    body { font-family: system-ui, -apple-system, Arial; margin: 0; padding: 24px; background:#fff; }
    .card { max-width: 520px; margin: 0 auto; border: 1px solid #eee; border-radius: 16px; padding: 18px; }
    h1 { font-size: 22px; margin: 0 0 8px; }
    p { margin: 0 0 14px; color: #444; }
    pre { background: #f6f6f6; padding: 14px; border-radius: 12px; white-space: pre-wrap; word-break: break-word; font-size: 15px; }
    button { width: 100%; padding: 14px; font-size: 18px; border: 0; border-radius: 12px; cursor: pointer; }
    .ok { margin-top: 10px; color: #0a7; font-weight: 700; display:none; }
    .err { margin-top: 10px; color: #b00; font-weight: 700; display:none; }
    .small { margin-top: 12px; font-size: 12px; color: #777; }
  </style>
</head>

<body>
  <div class="card">
    <h1 id="title">Paga con transferencia</h1>
    <p>Copia y pega estos datos en tu app bancaria.</p>

    <pre id="datos">Cargandoâ€¦</pre>

    <button id="copiar" disabled>ðŸ“‹ Copiar datos para transferir</button>
    <div id="ok" class="ok">Copiado âœ…</div>
    <div id="err" class="err">No encontramos este cobrador</div>

    <div class="small">TuQR solo muestra datos. La transferencia se hace en tu banco.</div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const id = (params.get('id') || '').trim();

    const datosEl = document.getElementById('datos');
    const btn = document.getElementById('copiar');
    const ok = document.getElementById('ok');
    const err = document.getElementById('err');
    const title = document.getElementById('title');

    // Limpia caracteres invisibles / espacios raros que algunas apps odian al pegar
    function clean(s) {
      return String(s ?? '')
        .normalize('NFC')
        .replace(/\u00A0/g, ' ')     // NBSP -> espacio normal
        .replace(/[ \t]+$/gm, '')   // elimina espacios al final de cada lÃ­nea
        .trim();
    }

    // Construye texto "tipo WhatsApp": SOLO texto + saltos de lÃ­nea reales
    function buildText(d) {
      const lines = [
        `Nombre: ${clean(d.nombre)}`,
        `RUT: ${clean(d.rut)}`,
        `Banco: ${clean(d.banco)}`,
        `Tipo de cuenta: ${clean(d.tipoCuenta)}`,
        `Numero de cuenta: ${clean(d.numeroCuenta)}`
      ];
      return lines.join('\n');
    }

    async function init() {
      try {
        const res = await fetch('./data.json', { cache: 'no-store' });
        const all = await res.json();
        const d = all[id];

        if (!id || !d) {
          datosEl.textContent = 'CÃ³digo invÃ¡lido';
          err.style.display = 'block';
          return;
        }

        title.textContent = `Paga a ${clean(d.nombre)}`;
        const text = buildText(d);
        datosEl.textContent = text;
        btn.disabled = false;

        // âœ… registrar visita por cobrador
        gtag('event', 'payer_page_view', { merchant_id: id });

        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(text);
          } catch {
            // Fallback mÃ¡s robusto (iOS / apps estrictas)
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.setAttribute('readonly', '');
            ta.style.position = 'fixed';
            ta.style.top = '-9999px';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            ta.setSelectionRange(0, ta.value.length);
            document.execCommand('copy');
            document.body.removeChild(ta);
          }

          ok.style.display = 'block';
          setTimeout(() => ok.style.display = 'none', 1500);

          // âœ… registrar click copiar por cobrador
          gtag('event', 'copy_click', { merchant_id: id });
        });

      } catch (e) {
        datosEl.textContent = 'Error cargando datos';
      }
    }

    init();
  </script>
</body>
</html>
